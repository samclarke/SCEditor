(function($,window,document){"use strict";var _templates={html:'<!DOCTYPE html><html><head><style>.ie * {min-height: auto !important}</style><meta http-equiv="Content-Type" content="text/html;charset={charset}" /><link rel="stylesheet" type="text/css" href="{style}" /></head><body contenteditable="true"></body></html>',toolbarButton:'<a class="sceditor-button sceditor-button-{name}" data-sceditor-command="{name}" unselectable="on"><div unselectable="on">{dispName}</div></a>',emoticon:'<img src="{url}" data-sceditor-emoticon="{key}" alt="{key}" title="{tooltip}" />',fontOpt:'<a class="sceditor-font-option" href="#" data-font="{font}"><font face="{font}">{font}</font></a>',sizeOpt:'<a class="sceditor-fontsize-option" data-size="{size}" href="#"><font size="{size}">{size}</font></a>',pastetext:'<div><label for="txt">{label}</label> <textarea cols="20" rows="7" id="txt"></textarea></div><div><input type="button" class="button" value="{insert}" /></div>',table:'<div><label for="rows">{rows}</label><input type="text" id="rows" value="2" /></div><div><label for="cols">{cols}</label><input type="text" id="cols" value="2" /></div><div><input type="button" class="button" value="{insert}" /></div>',image:'<div><label for="link">{url}</label> <input type="text" id="image" value="http://" /></div><div><label for="width">{width}</label> <input type="text" id="width" size="2" /></div><div><label for="height">{height}</label> <input type="text" id="height" size="2" /></div><div><input type="button" class="button" value="{insert}" /></div>',email:'<div><label for="email">{label}</label> <input type="text" id="email" /></div><div><input type="button" class="button" value="{insert}" /></div>',link:'<div><label for="link">{url}</label> <input type="text" id="link" value="http://" /></div><div><label for="des">{desc}</label> <input type="text" id="des" /></div><div><input type="button" class="button" value="{ins}" /></div>',youtubeMenu:'<div><label for="link">{label}</label> <input type="text" id="link" value="http://" /></div><div><input type="button" class="button" value="{insert}" /></div>',youtube:'<iframe width="560" height="315" src="http://www.youtube.com/embed/{id}?wmode=opaque" data-youtube-id="{id}" frameborder="0" allowfullscreen></iframe>'},_tmpl=function(name,params,createHTML){var template=_templates[name];return $.each(params,function(name,val){template=template.replace(RegExp("\\{"+name+"\\}","g"),val)}),createHTML&&(template=$(template)),template};$.sceditor=function(el,options){var $editorContainer,$toolbar,$wysiwygEditor,wysiwygEditor,$sourceEditor,sourceEditor,$dropdown,lastRange,locale,rangeHelper,$blurElm,pluginManager,currentNode,currentSelection,isSelectionCheckPending,isRequired,init,replaceEmoticons,handleCommand,saveRange,initEditor,initPlugins,initLocale,initToolBar,initOptions,initEvents,initCommands,initResize,initEmoticons,getWysiwygDoc,handlePasteEvt,handlePasteData,handleKeyPress,handleFormReset,handleMouseDown,handleEvent,handleDocumentClick,handleWindowResize,updateToolBar,updateActiveButtons,sourceEditorSelectedText,appendNewLine,checkSelectionChanged,checkNodeChanged,autofocus,base=this,original=el.get?el.get(0):el,$original=$(original),keyPressFuncs=[],preLoadCache=[],requireNewLineFix=[],btnStateHandlers=[];base.commands=$.extend(!0,{},options.commands||$.sceditor.commands),init=function(){if($original.data("sceditor",base),base.opts=$.extend({},$.sceditor.defaultOptions,options),base.opts.locale&&"en"!==base.opts.locale&&initLocale(),$editorContainer=$('<div class="sceditor-container" />').insertAfter($original),null!==base.opts.zIndex&&$editorContainer.css("z-index",base.opts.zIndex),$.sceditor.ie&&$editorContainer.addClass("ie").addClass("ie"+$.sceditor.ie),isRequired=!!$original.attr("required"),$original.removeAttr("required"),initPlugins(),initToolBar(),initEditor(),initCommands(),initOptions(),initEvents(),base.opts.autofocus&&autofocus(),$.sceditor.isWysiwygSupported||base.toggleSourceMode(),initEmoticons(),base.opts.autoExpand)var interval=setInterval(function(){document.readyState&&"complete"!==document.readyState||(base.expandToContent(),clearInterval(interval))},10);updateActiveButtons(),pluginManager.call("ready")},initPlugins=function(){var plugins=base.opts.plugins;plugins=plugins?(""+plugins).split(","):[],pluginManager=new $.sceditor.PluginManager(base),$.each(plugins,function(idx,plugin){pluginManager.register($.trim(plugin))})},initLocale=function(){var lang;$.sceditor.locale[base.opts.locale]?locale=$.sceditor.locale[base.opts.locale]:(lang=base.opts.locale.split("-"),$.sceditor.locale[lang[0]]&&(locale=$.sceditor.locale[lang[0]])),locale&&locale.dateFormat&&(base.opts.dateFormat=locale.dateFormat)},initEditor=function(){var $body,doc,$doc,tabIndex;$sourceEditor=$("<textarea></textarea>").hide(),$wysiwygEditor=$('<iframe frameborder="0"></iframe>'),"https:"===window.location.protocol&&$wysiwygEditor.attr("src","javascript:false"),$editorContainer.append($wysiwygEditor).append($sourceEditor),wysiwygEditor=$wysiwygEditor[0],sourceEditor=$sourceEditor[0],base.width(base.opts.width||$original.width()),base.height(base.opts.height||$original.height()),doc=getWysiwygDoc(),$doc=$(doc),doc.open(),doc.write(_tmpl("html",{charset:base.opts.charset,style:base.opts.style})),doc.close(),base.readOnly(!!base.opts.readOnly),$body=$doc.find("body"),$.sceditor.ie&&$doc.find("html").addClass("ie").addClass("ie"+$.sceditor.ie),(/iPhone|iPod|iPad| wosbrowser\//i.test(navigator.userAgent)||$.sceditor.ie)&&$body.height("100%"),rangeHelper=new $.sceditor.rangeHelper(wysiwygEditor.contentWindow),base.val($original.hide().val()),(tabIndex=$original.attr("tabindex"))!==void 0&&($sourceEditor.attr("tabindex",tabIndex),$wysiwygEditor.attr("tabindex",tabIndex))},initOptions=function(){var $doc=$(getWysiwygDoc()),$body=$doc.find("body");base.opts.autoUpdate&&($body.bind("blur",base.updateOriginal),$sourceEditor.bind("blur",base.updateOriginal)),null===base.opts.rtl&&(base.opts.rtl="rtl"===$sourceEditor.css("direction")),base.opts.rtl&&base.rtl(!0),base.opts.autoExpand&&$doc.bind("keyup",base.expandToContent),base.opts.resizeEnabled&&initResize(),base.opts.id&&$editorContainer.attr("id",base.opts.id)},initEvents=function(){var $doc=$(getWysiwygDoc());$(document).click(handleDocumentClick),$(original.form).bind("reset",handleFormReset).submit(base.updateOriginal),$(window).bind("resize orientationChanged",handleWindowResize),$doc.find("body").keypress(handleKeyPress).keyup(appendNewLine).bind("paste",handlePasteEvt).bind($.sceditor.ie?"selectionchange":"keyup focus blur contextmenu mouseup touchend click",checkSelectionChanged).bind("keydown keyup keypress focus blur contextmenu",handleEvent),$sourceEditor.bind("keydown keyup keypress focus blur contextmenu",handleEvent),$doc.keypress(handleKeyPress).mousedown(handleMouseDown).bind($.sceditor.ie?"selectionchange":"focus blur contextmenu mouseup click",checkSelectionChanged).bind("beforedeactivate keyup",saveRange).keyup(appendNewLine).focus(function(){lastRange=null}),$editorContainer.bind("selectionchanged",updateActiveButtons).bind("selectionchanged",checkNodeChanged).bind("selectionchanged",handleEvent).bind("nodechanged",handleEvent)},initToolBar=function(){var $group,$button,buttons,i,x,buttonClick,groups=base.opts.toolbar.split("|");for(buttonClick=function(){var $this=$(this);return $this.hasClass("disabled")||handleCommand($this,base.commands[$this.data("sceditor-command")]),updateActiveButtons(),!1},$toolbar=$('<div class="sceditor-toolbar" unselectable="on" />'),i=0;groups.length>i;i++){for($group=$('<div class="sceditor-group" />'),buttons=groups[i].split(","),x=0;buttons.length>x;x++)base.commands[buttons[x]]&&($button=_tmpl("toolbarButton",{name:buttons[x],dispName:base.commands[buttons[x]].tooltip||buttons[x]},!0).click(buttonClick).data("sceditor-txtmode",!!base.commands[buttons[x]].txtExec).data("sceditor-wysiwygmode",!!base.commands[buttons[x]].exec),base.commands[buttons[x]].tooltip&&$button.attr("title",base._(base.commands[buttons[x]].tooltip)),base.commands[buttons[x]].exec||$button.addClass("disabled"),$group.append($button));$toolbar.append($group)}base.opts.toolbarContainer?$(base.opts.toolbarContainer).append($toolbar):$editorContainer.append($toolbar)},initCommands=function(){$.each(base.commands,function(name,cmd){cmd.keyPress&&keyPressFuncs.push(cmd.keyPress),cmd.forceNewLineAfter&&$.isArray(cmd.forceNewLineAfter)&&(requireNewLineFix=$.merge(requireNewLineFix,cmd.forceNewLineAfter)),cmd.state?btnStateHandlers.push({name:name,state:cmd.state}):"string"==typeof cmd.exec&&btnStateHandlers.push({name:name,state:cmd.exec})})},initResize=function(){var minHeight,maxHeight,minWidth,maxWidth,mouseMoveFunc,mouseUpFunc,$grip=$('<div class="sceditor-grip" />'),$cover=$('<div class="sceditor-resize-cover" />'),startX=0,startY=0,startWidth=0,startHeight=0,origWidth=$editorContainer.width(),origHeight=$editorContainer.height(),dragging=!1,rtl=base.rtl();minHeight=base.opts.resizeMinHeight||origHeight/1.5,maxHeight=base.opts.resizeMaxHeight||2.5*origHeight,minWidth=base.opts.resizeMinWidth||origWidth/1.25,maxWidth=base.opts.resizeMaxWidth||1.25*origWidth,mouseMoveFunc=function(e){"touchmove"===e.type&&(e=window.event);var newHeight=startHeight+(e.pageY-startY),newWidth=rtl?startWidth-(e.pageX-startX):startWidth+(e.pageX-startX);maxWidth>0&&newWidth>maxWidth&&(newWidth=maxWidth),maxHeight>0&&newHeight>maxHeight&&(newHeight=maxHeight),base.opts.resizeWidth&&newWidth>=minWidth&&(0>maxWidth||maxWidth>=newWidth)&&base.width(newWidth),base.opts.resizeHeight&&newHeight>=minHeight&&(0>maxHeight||maxHeight>=newHeight)&&base.height(newHeight),e.preventDefault()},mouseUpFunc=function(e){dragging&&(dragging=!1,$cover.hide(),$editorContainer.removeClass("resizing"),$(document).unbind("touchmove mousemove",mouseMoveFunc),$(document).unbind("touchend mouseup",mouseUpFunc),e.preventDefault())},$editorContainer.append($grip),$editorContainer.append($cover.hide()),$grip.bind("touchstart mousedown",function(e){"touchstart"===e.type&&(e=window.event),startX=e.pageX,startY=e.pageY,startWidth=$editorContainer.width(),startHeight=$editorContainer.height(),dragging=!0,$editorContainer.addClass("resizing"),$cover.show(),$(document).bind("touchmove mousemove",mouseMoveFunc),$(document).bind("touchend mouseup",mouseUpFunc),e.preventDefault()})},initEmoticons=function(){if(!(0>base.opts.toolbar.indexOf("emoticon"))){base.opts.emoticonsRoot&&base.opts.emoticons&&$.each(base.opts.emoticons,function(idx,emoticons){$.each(emoticons,function(key,url){base.opts.emoticons[idx][key]=base.opts.emoticonsRoot+(url.url||url)})});var emoticon,emoticons=$.extend({},base.opts.emoticons.more,base.opts.emoticons.dropdown,base.opts.emoticons.hidden);$.each(emoticons,function(key,url){emoticon=document.createElement("img"),emoticon.src=url.url||url,preLoadCache.push(emoticon)})}},autofocus=function(){var rng,doc=wysiwygEditor.contentWindow.document,body=doc.body;return doc.createRange?(body.firstChild&&(rng=doc.createRange(),rng.setStart(body.firstChild,0),rng.setEnd(body.firstChild,0),rangeHelper.selectRange(rng),body.focus()),void 0):base.focus()},base.readOnly=function(readOnly){return"boolean"!=typeof readOnly?"readonly"===$sourceEditor.attr("readonly"):(getWysiwygDoc().body.contentEditable=!readOnly,readOnly?$sourceEditor.attr("readonly","readonly"):$sourceEditor.removeAttr("readonly"),updateToolBar(readOnly),this)},base.rtl=function(rtl){var dir=rtl?"rtl":"ltr";return"boolean"!=typeof rtl?"rtl"===$sourceEditor.attr("dir"):($(getWysiwygDoc().body).attr("dir",dir),$sourceEditor.attr("dir",dir),$editorContainer.removeClass("rtl").removeClass("ltr").addClass(dir),this)},updateToolBar=function(disable){var inSourceMode=base.inSourceMode();$toolbar.find(".sceditor-button").removeClass("disabled").each(function(){var button=$(this);disable===!0||inSourceMode&&!button.data("sceditor-txtmode")?button.addClass("disabled"):inSourceMode||button.data("sceditor-wysiwygmode")||button.addClass("disabled")})},base.width=function(width,saveWidth){return width||0===width?(base.dimensions(width,null,saveWidth),this):$editorContainer.width()},base.dimensions=function(width,height,save){var toolbarHeight,updateheight=!1;return width=width||0===width?width:!1,height=height||0===height?height:!1,width===!1&&height===!1?{width:base.width(),height:base.height()}:($wysiwygEditor.data("outerWidthOffset")===void 0&&base.updateStyleCache(),width!==!1&&width!==base.width()&&(save!==!1&&(base.opts.width=width),width=$editorContainer.width(width).width(),wysiwygEditor.style.width=width-$wysiwygEditor.data("outerWidthOffset")+"px",sourceEditor.style.width=width-$sourceEditor.data("outerWidthOffset")+"px",toolbarHeight=base.opts.toolbarContainer?0:$toolbar.outerHeight(!0),updateheight=toolbarHeight!==(base.opts.toolbarContainer?0:$toolbar.outerHeight(!0)),height=height!==!1?height:base.height()),height!==!1&&height!==base.height()&&(save!==!1&&(base.opts.height=height),height=$editorContainer.height(height).height(),height-=base.opts.toolbarContainer?0:$toolbar.outerHeight(!0),updateheight=!0),updateheight&&(wysiwygEditor.style.height=height-$wysiwygEditor.data("outerHeightOffset")+"px",sourceEditor.style.height=height-$sourceEditor.data("outerHeightOffset")+"px"),this)},base.updateStyleCache=function(){$wysiwygEditor.data("outerWidthOffset",$wysiwygEditor.outerWidth(!0)-$wysiwygEditor.width()),$sourceEditor.data("outerWidthOffset",$sourceEditor.outerWidth(!0)-$sourceEditor.width()),$wysiwygEditor.data("outerHeightOffset",$wysiwygEditor.outerHeight(!0)-$wysiwygEditor.height()),$sourceEditor.data("outerHeightOffset",$sourceEditor.outerHeight(!0)-$sourceEditor.height())},base.height=function(height,saveHeight){return height||0===height?(base.dimensions(null,height,saveHeight),this):$editorContainer.height()},base.maximize=function(maximize){return maximize===void 0?$editorContainer.is(".sceditor-maximize"):(maximize=!!maximize,7>$.sceditor.ie&&$("html, body").toggleClass("sceditor-maximize",maximize),$editorContainer.toggleClass("sceditor-maximize",maximize),base.width(maximize?"100%":base.opts.width,!1),base.height(maximize?"100%":base.opts.height,!1),this)},base.expandToContent=function(ignoreMaxHeight){var doc=getWysiwygDoc(),currentHeight=$editorContainer.height(),height=doc.body.scrollHeight||doc.documentElement.scrollHeight,padding=currentHeight-$wysiwygEditor.height(),maxHeight=base.opts.resizeMaxHeight||2*(base.opts.height||$original.height());height+=padding,ignoreMaxHeight!==!0&&height>maxHeight&&(height=maxHeight),height>currentHeight&&base.height(height)},base.destroy=function(){pluginManager.destroy(),rangeHelper=null,lastRange=null,pluginManager=null,$(document).unbind("click",handleDocumentClick),$(window).unbind("resize",handleWindowResize),$(original.form).unbind("reset",handleFormReset).unbind("submit",base.updateOriginal),$(getWysiwygDoc().body).unbind(),$(getWysiwygDoc()).unbind().find("*").remove(),$sourceEditor.unbind().remove(),$editorContainer.unbind().find("*").unbind().remove(),$editorContainer.remove(),$original.removeData("sceditor").removeData("sceditorbbcode").show(),isRequired&&$original.attr("required","required")},base.createDropDown=function(menuItem,dropDownName,content,ieUnselectable){base.closeDropDown(),ieUnselectable!==!1&&$(content).find(":not(input,textarea)").filter(function(){return 1===this.nodeType}).attr("unselectable","on");var css={top:menuItem.offset().top,left:menuItem.offset().left,marginTop:menuItem.outerHeight()};$.extend(css,base.opts.dropDownCss),$dropdown=$('<div class="sceditor-dropdown sceditor-'+dropDownName+'" />').css(css).append(content).appendTo($("body")).click(function(e){e.stopPropagation()})},handleDocumentClick=function(e){3!==e.which&&base.closeDropDown()},handlePasteEvt=function(e){function handlePaste(elm,pastearea){if(elm.childNodes.length>0){for(;elm.firstChild;)pastearea.appendChild(elm.firstChild);for(;prePasteContent.firstChild;)elm.appendChild(prePasteContent.firstChild);handlePasteData(elm,pastearea)}else{if(checkCount>25){for(;prePasteContent.firstChild;)elm.appendChild(prePasteContent.firstChild);return rangeHelper.restoreRange(),void 0}++checkCount,setTimeout(function(){handlePaste(elm,pastearea)},20)}}var html,elm=getWysiwygDoc().body,checkCount=0,pastearea=elm.ownerDocument.createElement("div"),prePasteContent=elm.ownerDocument.createDocumentFragment();if(base.opts.disablePasting)return!1;if(base.opts.enablePasteFiltering){if(rangeHelper.saveRange(),document.body.appendChild(pastearea),e&&e.clipboardData&&e.clipboardData.getData&&((html=e.clipboardData.getData("text/html"))||(html=e.clipboardData.getData("text/plain"))))return pastearea.innerHTML=html,handlePasteData(elm,pastearea),e.stopPropagation(),e.preventDefault(),!1;for(;elm.firstChild;)prePasteContent.appendChild(elm.firstChild);return handlePaste(elm,pastearea),base.focus(),!0}},handlePasteData=function(elm,pastearea){$.sceditor.dom.fixNesting(pastearea);var pasteddata=pastearea.innerHTML;pluginManager.hasHandler("toSource")&&(pasteddata=pluginManager.callOnlyFirst("toSource",pasteddata,$(pastearea))),pastearea.parentNode.removeChild(pastearea),pluginManager.hasHandler("toWysiwyg")&&(pasteddata=pluginManager.callOnlyFirst("toWysiwyg",pasteddata,!0)),rangeHelper.restoreRange(),rangeHelper.insertHTML(pasteddata)},base.closeDropDown=function(focus){$dropdown&&($dropdown.unbind().remove(),$dropdown=null),focus===!0&&base.focus()},getWysiwygDoc=function(){return wysiwygEditor.contentDocument?wysiwygEditor.contentDocument:wysiwygEditor.contentWindow&&wysiwygEditor.contentWindow.document?wysiwygEditor.contentWindow.document:wysiwygEditor.document?wysiwygEditor.document:null},base.wysiwygEditorInsertHtml=function(html,endHtml,overrideCodeBlocking){base.focus(),(overrideCodeBlocking||!$(rangeHelper.parentNode()).is("code")&&0===$(rangeHelper.parentNode()).parents("code").length)&&(rangeHelper.insertHTML(html,endHtml),appendNewLine())},base.wysiwygEditorInsertText=function(text,endText){base.wysiwygEditorInsertHtml($.sceditor.escapeEntities(text),$.sceditor.escapeEntities(endText))},base.insertText=function(text,endText){return base.inSourceMode()?base.sourceEditorInsertText(text,endText):base.wysiwygEditorInsertText(text,endText),this},base.sourceEditorInsertText=function(text,endText){var range,start,end,txtLen,scrollTop;scrollTop=sourceEditor.scrollTop,sourceEditor.focus(),sourceEditor.selectionStart!==void 0?(start=sourceEditor.selectionStart,end=sourceEditor.selectionEnd,txtLen=text.length,endText&&(text+=sourceEditor.value.substring(start,end)+endText),sourceEditor.value=sourceEditor.value.substring(0,start)+text+sourceEditor.value.substring(end,sourceEditor.value.length),sourceEditor.selectionStart=start+text.length-(endText?endText.length:0),sourceEditor.selectionEnd=sourceEditor.selectionStart):document.selection.createRange!==void 0?(range=document.selection.createRange(),endText&&(text+=range.text+endText),range.text=text,endText&&range.moveEnd("character",0-endText.length),range.moveStart("character",range.End-range.Start),range.select()):sourceEditor.value+=text+endText,sourceEditor.scrollTop=scrollTop,sourceEditor.focus()},base.getRangeHelper=function(){return rangeHelper},base.val=function(val,filter){return"string"==typeof val?(base.inSourceMode()?base.setSourceEditorValue(val):(filter!==!1&&pluginManager.hasHandler("toWysiwyg")&&(val=pluginManager.callOnlyFirst("toWysiwyg",val)),base.setWysiwygEditorValue(val)),this):base.inSourceMode()?base.getSourceEditorValue(!1):base.getWysiwygEditorValue()},base.insert=function(start,end,filter,convertEmoticons){if(base.inSourceMode())base.sourceEditorInsertText(start,end);else{if(end){var html=base.getRangeHelper().selectedHtml(),frag=$("<div>").appendTo($("body")).hide().html(html);filter!==!1&&(pluginManager.hasHandler("toSource")&&(html=pluginManager.callOnlyFirst("toSource",html,frag)),frag.remove()),start+=html+end}pluginManager.hasHandler("toWysiwyg")&&(start=pluginManager.callOnlyFirst("toWysiwyg",start,!0)),convertEmoticons!==!1&&(start=replaceEmoticons(start)),base.wysiwygEditorInsertHtml(start)}return this},base.getWysiwygEditorValue=function(filter){var html,$body=$wysiwygEditor.contents().find("body");return $.sceditor.ie&&base.focus(),rangeHelper.saveRange(),$.sceditor.dom.fixNesting($body.get(0)),html=$body.html(),filter!==!1&&pluginManager.hasHandler("toSource")&&(html=pluginManager.callOnlyFirst("toSource",html,$body)),rangeHelper.restoreRange(),lastRange=null,html},base.getSourceEditorValue=function(filter){var val=$sourceEditor.val();return filter!==!1&&pluginManager.hasHandler("toWysiwyg")&&(val=pluginManager.callOnlyFirst("toWysiwyg",val)),val},base.setWysiwygEditorValue=function(value){value||(value="<p>"+($.sceditor.ie?"":"<br />")+"</p>"),getWysiwygDoc().body.innerHTML=replaceEmoticons(value),appendNewLine()},base.setSourceEditorValue=function(value){$sourceEditor.val(value)},base.updateOriginal=function(){$original.val(base.val())},replaceEmoticons=function(html){if(-1===base.opts.toolbar.indexOf("emoticon"))return html;var emoticons=$.extend({},base.opts.emoticons.more,base.opts.emoticons.dropdown,base.opts.emoticons.hidden);return $.each(emoticons,function(key,url){var reg=$.sceditor.regexEscape(key)+"(?=([^\\<\\>]*?<(?!/code)|[^\\<\\>]*?$))",group="";base.opts.emoticonsCompat&&(reg="((>|^|\\s| | | | |&nbsp;))"+reg+"(?=(\\s|$|<| | | | |&nbsp;))",group="$1"),html=html.replace(RegExp(reg,"gm"),group+_tmpl("emoticon",{key:key,url:url.url||url,tooltip:url.tooltip||key}))}),html},base.inSourceMode=function(){return $editorContainer.hasClass("sourceMode")},base.sourceMode=function(enable){return"boolean"!=typeof enable?base.inSourceMode():((base.inSourceMode()&&!enable||!base.inSourceMode()&&enable)&&base.toggleSourceMode(),this)},base.toggleSourceMode=function(){($.sceditor.isWysiwygSupported||!base.inSourceMode())&&(base.inSourceMode()?base.setWysiwygEditorValue(base.getSourceEditorValue()):base.setSourceEditorValue(base.getWysiwygEditorValue()),lastRange=null,$sourceEditor.toggle(),$wysiwygEditor.toggle(),base.inSourceMode()?$editorContainer.removeClass("sourceMode").addClass("wysiwygMode"):$editorContainer.removeClass("wysiwygMode").addClass("sourceMode"),updateToolBar(),updateActiveButtons())},sourceEditorSelectedText=function(){return sourceEditor.focus(),null!=sourceEditor.selectionStart?sourceEditor.value.substring(sourceEditor.selectionStart,sourceEditor.selectionEnd):document.selection.createRange?document.selection.createRange().text:void 0},handleCommand=function(caller,command){return base.inSourceMode()?(command.txtExec&&($.isArray(command.txtExec)?base.sourceEditorInsertText.apply(base,command.txtExec):command.txtExec.call(base,caller,sourceEditorSelectedText())),void 0):(command.exec&&($.isFunction(command.exec)?command.exec.call(base,caller):base.execCommand(command.exec,command.hasOwnProperty("execParam")?command.execParam:null)),void 0)},saveRange=function(){$.sceditor.ie&&(lastRange=rangeHelper.selectedRange())},base.execCommand=function(command,param){var executed=!1,$parentNode=$(rangeHelper.parentNode());if(base.focus(),!$parentNode.is("code")&&0===$parentNode.parents("code").length){if(getWysiwygDoc())try{executed=getWysiwygDoc().execCommand(command,!1,param)}catch(e){}!executed&&base.commands[command]&&base.commands[command].errorMessage&&alert(base._(base.commands[command].errorMessage))}},checkSelectionChanged=function(){isSelectionCheckPending||(isSelectionCheckPending=!0,setTimeout(function(){rangeHelper.compare(currentSelection)||(currentSelection=rangeHelper.cloneSelected(),$editorContainer.trigger($.Event("selectionchanged"))),isSelectionCheckPending=!1},100))},checkNodeChanged=function(){var node=rangeHelper.parentNode();currentNode!==node&&($editorContainer.trigger($.Event("nodechanged",{oldNode:currentNode,newNode:node})),currentNode=node)},base.currentNode=function(){return currentNode},updateActiveButtons=function(e){var state,stateHandler,firstBlock,$button,parent,doc=getWysiwygDoc(),i=btnStateHandlers.length,inSourceMode=base.sourceMode();if(base.sourceMode()||base.readOnly())$toolbar.find(".sceditor-button").removeClass("active");else for(parent=e?e.newNode:rangeHelper.parentNode(),firstBlock=rangeHelper.getFirstBlockParent(parent);i--;)if(state=0,stateHandler=btnStateHandlers[i],$button=$toolbar.find(".sceditor-button-"+stateHandler.name),inSourceMode&&!$button.data("sceditor-txtmode"))$button.addClass("disabled");else if(inSourceMode||$button.data("sceditor-wysiwygmode")){if("string"==typeof stateHandler.state)try{state=doc.queryCommandEnabled(stateHandler.state)?0:-1,state>-1&&(state=doc.queryCommandState(stateHandler.state)?1:0)}catch(e){}else state=stateHandler.state.call(base,parent,firstBlock);0>state?$button.addClass("disabled"):$button.removeClass("disabled"),state>0?$button.addClass("active"):$button.removeClass("active")}else $button.addClass("disabled")},handleKeyPress=function(e){var $parentNode,i=keyPressFuncs.length;if(base.closeDropDown(),$parentNode=$(rangeHelper.parentNode()),13===e.which&&($parentNode.is("code,blockquote,pre")||0!==$parentNode.parents("code,blockquote,pre").length))return lastRange=null,base.wysiwygEditorInsertHtml("<br />",null,!0),!1;if(!$parentNode.is("code")&&0===$parentNode.parents("code").length)for(;i--;)keyPressFuncs[i].call(base,e,wysiwygEditor,$sourceEditor)},appendNewLine=function(){var name,inBlock,doc=getWysiwygDoc();$.sceditor.dom.rTraverse(doc.body,function(node){return name=node.nodeName.toLowerCase(),$.inArray(name,requireNewLineFix)>-1&&(inBlock=!0),3===node.nodeType&&!/^\s*$/.test(node.nodeValue)||"br"===node.nodeName.toLowerCase()||$.sceditor.ie&&!node.firstChild&&!$.sceditor.dom.isInline(node,!1)?(inBlock&&$(doc.body).append($("<div>"+($.sceditor.ie?"":"<br />")+"</div>\n")),!1):void 0})},handleFormReset=function(){base.val($original.val())},handleMouseDown=function(){base.closeDropDown(),lastRange=null},handleWindowResize=function(){return base.maximize()?(base.height("100%",!1).width("100%",!1),void 0):(base.opts.height&&(""+base.opts.height).indexOf("%")>-1&&base.height($editorContainer.parent().height()*(parseFloat(base.opts.height)/100)),base.opts.width&&(""+base.opts.width).indexOf("%")>-1&&base.width($editorContainer.parent().width()*(parseFloat(base.opts.width)/100)),void 0)},base._=function(){var args=arguments;return locale&&locale[args[0]]&&(args[0]=locale[args[0]]),args[0].replace(/\{(\d+)\}/g,function(str,p1){return args[p1-0+1]!==void 0?args[p1-0+1]:"{"+p1+"}"})},handleEvent=function(e){var customEvent,clone=$.extend({},e);pluginManager.call(clone.type+"Event",e,base),delete clone.type,customEvent=$.Event((e.target===sourceEditor?"scesrc":"scewys")+e.type,clone),$editorContainer.trigger.apply($editorContainer,[customEvent,base]),customEvent.isDefaultPrevented()&&e.preventDefault(),customEvent.isImmediatePropagationStopped()&&customEvent.stopImmediatePropagation(),customEvent.isPropagationStopped()&&customEvent.stopPropagation()},base.bind=function(events,handler,excludeWysiwyg,excludeSource){var i=events.length;for(events=events.split(" ");i--;)$.isFunction(handler)&&(excludeWysiwyg||$editorContainer.bind("scewys"+events[i],handler),excludeSource||$editorContainer.bind("scesrc"+events[i],handler));return this},base.unbind=function(events,handler,excludeWysiwyg,excludeSource){var i=events.length;for(events=events.split(" ");i--;)$.isFunction(handler)&&(excludeWysiwyg||$editorContainer.unbind("scewys"+events[i],handler),excludeSource||$editorContainer.unbind("scesrc"+events[i],handler));return this},base.blur=function(handler,excludeWysiwyg,excludeSource){return $.isFunction(handler)?base.bind("blur",handler,excludeWysiwyg,excludeSource):base.sourceMode()?$sourceEditor.blur():($blurElm||($blurElm=$('<input style="width:0;height:0;opacity:0;border:0;padding:0;filter:alpha(opacity=0)" type="text" />').appendTo($editorContainer)),$blurElm.removeAttr("disabled").show().focus().blur().hide().attr("disabled","disabled")),this},base.focus=function(handler,excludeWysiwyg,excludeSource){return $.isFunction(handler)?base.bind("focus",handler,excludeWysiwyg,excludeSource):base.inSourceMode()?sourceEditor.focus():(wysiwygEditor.contentWindow.focus(),lastRange&&(rangeHelper.selectRange(lastRange),lastRange=null)),this},base.keyDown=function(handler,excludeWysiwyg,excludeSource){return base.bind("keydown",handler,excludeWysiwyg,excludeSource)},base.keyPress=function(handler,excludeWysiwyg,excludeSource){return base.bind("keypress",handler,excludeWysiwyg,excludeSource)},base.keyUp=function(handler,excludeWysiwyg,excludeSource){return base.bind("keyup",handler,excludeWysiwyg,excludeSource)},base.nodeChanged=function(handler){return base.bind("nodechanged",handler,!1,!0)},base.selectionChanged=function(handler){return base.bind("selectionchanged",handler,!1,!0)},init()},$.sceditor.ie=function(){var undef,v=3,div=document.createElement("div"),all=div.getElementsByTagName("i");do div.innerHTML="<!--[if gt IE "+ ++v+"]><i></i><![endif]-->";while(all[0]);return document.all&&window.atob&&(v=10),v>4?v:undef}(),$.sceditor.isWysiwygSupported=function(){var match,contentEditable=$('<div contenteditable="true">')[0].contentEditable,contentEditableSupported=contentEditable!==void 0&&"inherit"!==contentEditable,userAgent=navigator.userAgent;if(!contentEditableSupported)return!1;var isUnsupported=/Opera Mobi|Opera Mini/i.test(userAgent);return/Android/i.test(userAgent)&&(isUnsupported=!0,/Safari/.test(userAgent)&&(match=/Safari\/(\d+)/.exec(userAgent),isUnsupported=match&&match[1]?534>match[1]:!0)),/ Silk\//i.test(userAgent)&&(match=/AppleWebKit\/(\d+)/.exec(userAgent),isUnsupported=match&&match[1]?534>match[1]:!0),/iPhone|iPod|iPad/i.test(userAgent)&&(isUnsupported=!/OS [5-9](_\d)+ like Mac OS X/i.test(userAgent)),/fennec/i.test(userAgent)&&(isUnsupported=!1),!isUnsupported}(),$.sceditor.regexEscape=function(str){return str.replace(/[\$\?\[\]\.\*\(\)\|\\]/g,"\\$&").replace("<","&lt;").replace(">","&gt;")},$.sceditor.escapeEntities=function(str){return str?str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ {2}/g," &nbsp;").replace(/\r\n|\r/g,"\n").replace(/\n/g,"<br />"):str},$.sceditor.locale={},$.sceditor.commands={bold:{exec:"bold",tooltip:"Bold"},italic:{exec:"italic",tooltip:"Italic"},underline:{exec:"underline",tooltip:"Underline"},strike:{exec:"strikethrough",tooltip:"Strikethrough"},subscript:{exec:"subscript",tooltip:"Subscript"},superscript:{exec:"superscript",tooltip:"Superscript"},left:{exec:"justifyleft",tooltip:"Align left"},center:{exec:"justifycenter",tooltip:"Center"},right:{exec:"justifyright",tooltip:"Align right"},justify:{exec:"justifyfull",tooltip:"Justify"},font:{_dropDown:function(editor,caller,callback){for(var fonts=editor.opts.fonts.split(","),content=$("<div />"),clickFunc=function(){return callback($(this).data("font")),editor.closeDropDown(!0),!1},i=0;fonts.length>i;i++)content.append(_tmpl("fontOpt",{font:fonts[i]},!0).click(clickFunc));editor.createDropDown(caller,"font-picker",content)},exec:function(caller){var editor=this;$.sceditor.command.get("font")._dropDown(editor,caller,function(fontName){editor.execCommand("fontname",fontName)})},tooltip:"Font Name"},size:{_dropDown:function(editor,caller,callback){for(var content=$("<div />"),clickFunc=function(e){callback($(this).data("size")),editor.closeDropDown(!0),e.preventDefault()},i=1;7>=i;i++)content.append(_tmpl("sizeOpt",{size:i},!0).click(clickFunc));editor.createDropDown(caller,"fontsize-picker",content)},exec:function(caller){var editor=this;$.sceditor.command.get("size")._dropDown(editor,caller,function(fontSize){editor.execCommand("fontsize",fontSize)})},tooltip:"Font Size"},color:{_dropDown:function(editor,caller,callback){var i,x,color,colors,genColor={r:255,g:255,b:255},content=$("<div />"),colorColumns=editor.opts.colors?editor.opts.colors.split("|"):Array(21),html=[],cmd=$.sceditor.command.get("color");
if(!cmd._htmlCache){for(i=0;colorColumns.length>i;++i){for(colors=colorColumns[i]?colorColumns[i].split(","):Array(21),html.push('<div class="sceditor-color-column">'),x=0;colors.length>x;++x)color=colors[x]||"#"+genColor.r.toString(16)+genColor.g.toString(16)+genColor.b.toString(16),html.push('<a href="#" class="sceditor-color-option" style="background-color: '+color+'" data-color="'+color+'"></a>'),0===x%5?(genColor.g-=51,genColor.b=255):genColor.b-=51;html.push("</div>"),0===i%5?(genColor.r-=51,genColor.g=255,genColor.b=255):(genColor.g=255,genColor.b=255)}cmd._htmlCache=html.join("")}content.append(cmd._htmlCache).find("a").click(function(e){callback($(this).attr("data-color")),editor.closeDropDown(!0),e.preventDefault()}),editor.createDropDown(caller,"color-picker",content)},exec:function(caller){var editor=this;$.sceditor.command.get("color")._dropDown(editor,caller,function(color){editor.execCommand("forecolor",color)})},tooltip:"Font Color"},removeformat:{exec:"removeformat",tooltip:"Remove Formatting"},cut:{exec:"cut",tooltip:"Cut",errorMessage:"Your browser does not allow the cut command. Please use the keyboard shortcut Ctrl/Cmd-X"},copy:{exec:"copy",tooltip:"Copy",errorMessage:"Your browser does not allow the copy command. Please use the keyboard shortcut Ctrl/Cmd-C"},paste:{exec:"paste",tooltip:"Paste",errorMessage:"Your browser does not allow the paste command. Please use the keyboard shortcut Ctrl/Cmd-V"},pastetext:{exec:function(caller){var val,editor=this,content=_tmpl("pastetext",{label:editor._("Paste your text inside the following box:"),insert:editor._("Insert")},!0);content.find(".button").click(function(e){val=content.find("#txt").val(),val&&editor.wysiwygEditorInsertText(val),editor.closeDropDown(!0),e.preventDefault()}),editor.createDropDown(caller,"pastetext",content)},tooltip:"Paste Text"},bulletlist:{exec:"insertunorderedlist",tooltip:"Bullet list"},orderedlist:{exec:"insertorderedlist",tooltip:"Numbered list"},table:{exec:function(caller){var editor=this,content=_tmpl("table",{rows:editor._("Rows:"),cols:editor._("Cols:"),insert:editor._("Insert")},!0);content.find(".button").click(function(e){var rows=content.find("#rows").val()-0,cols=content.find("#cols").val()-0,html="<table>";if(!(1>rows||1>cols)){for(var row=0;rows>row;row++){html+="<tr>";for(var col=0;cols>col;col++)html+="<td>"+($.sceditor.ie?"":"<br />")+"</td>";html+="</tr>"}html+="</table>",editor.wysiwygEditorInsertHtml(html),editor.closeDropDown(!0),e.preventDefault()}}),editor.createDropDown(caller,"inserttable",content)},tooltip:"Insert a table"},horizontalrule:{exec:"inserthorizontalrule",tooltip:"Insert a horizontal rule"},code:{forceNewLineAfter:["code"],exec:function(){this.wysiwygEditorInsertHtml("<code>","<br /></code>")},tooltip:"Code"},image:{exec:function(caller){var editor=this,content=_tmpl("image",{url:editor._("URL:"),width:editor._("Width (optional):"),height:editor._("Height (optional):"),insert:editor._("Insert")},!0);content.find(".button").click(function(e){var val=content.find("#image").val(),width=content.find("#width").val(),height=content.find("#height").val(),attrs="";width&&(attrs+=' width="'+width+'"'),height&&(attrs+=' height="'+height+'"'),val&&"http://"!==val&&editor.wysiwygEditorInsertHtml("<img"+attrs+' src="'+val+'" />'),editor.closeDropDown(!0),e.preventDefault()}),editor.createDropDown(caller,"insertimage",content)},tooltip:"Insert an image"},email:{exec:function(caller){var editor=this,content=_tmpl("email",{label:editor._("E-mail:"),insert:editor._("Insert")},!0);content.find(".button").click(function(e){var val=content.find("#email").val();val&&(editor.focus(),editor.getRangeHelper().selectedHtml()?editor.execCommand("createlink","mailto:"+val):editor.wysiwygEditorInsertHtml('<a href="mailto:'+val+'">'+val+"</a>")),editor.closeDropDown(!0),e.preventDefault()}),editor.createDropDown(caller,"insertemail",content)},tooltip:"Insert an email"},link:{exec:function(caller){var editor=this,content=_tmpl("link",{url:editor._("URL:"),desc:editor._("Description (optional):"),ins:editor._("Insert")},!0);content.find(".button").click(function(e){var val=content.find("#link").val(),description=content.find("#des").val();val&&"http://"!==val&&(editor.focus(),!editor.getRangeHelper().selectedHtml()||description?(description||(description=val),editor.wysiwygEditorInsertHtml('<a href="'+val+'">'+description+"</a>")):editor.execCommand("createlink",val)),editor.closeDropDown(!0),e.preventDefault()}),editor.createDropDown(caller,"insertlink",content)},tooltip:"Insert a link"},unlink:{exec:"unlink",tooltip:"Unlink"},quote:{forceNewLineAfter:["blockquote"],exec:function(caller,html,author){var before="<blockquote>",end="</blockquote>";html?(author=author?"<cite>"+author+"</cite>":"",before=before+author+html+end+"<br />",end=null):""===this.getRangeHelper().selectedHtml()&&(end="<br />"+end),this.wysiwygEditorInsertHtml(before,end)},tooltip:"Insert a Quote"},emoticon:{exec:function(caller){var appendEmoticon,editor=this,end=editor.opts.emoticonsCompat?" ":"",content=$("<div />"),line=$("<div />");if(appendEmoticon=function(code,emoticon){line.append($("<img />").attr({src:$.isPlainObject(emoticon)?emoticon.url:emoticon,alt:code,title:$.isPlainObject(emoticon)?emoticon.tooltip||code:code}).click(function(e){editor.insert($(this).attr("alt")+end),editor.closeDropDown(!0),e.preventDefault()})),line.children().length>3&&(content.append(line),line=$("<div />"))},$.each(editor.opts.emoticons.dropdown,appendEmoticon),line.children().length>0&&content.append(line),editor.opts.emoticons.more){var more=$(this._('<a class="sceditor-more">{0}</a>',this._("More"))).click(function(){var emoticons=$.extend({},editor.opts.emoticons.dropdown,editor.opts.emoticons.more);return content=$("<div />"),$.each(emoticons,appendEmoticon),line.children().length>0&&content.append(line),editor.createDropDown(caller,"insertemoticon",content),!1});content.append(more)}editor.createDropDown(caller,"insertemoticon",content)},txtExec:function(caller){$.sceditor.command.get("emoticon").exec.call(this,caller)},keyPress:function(e){if(-1!==this.opts.toolbar.indexOf("emoticon")){var editor=this,pos=0,curChar=String.fromCharCode(e.which);return editor.EmoticonsCache||(editor.EmoticonsCache=[],$.each($.extend({},editor.opts.emoticons.more,editor.opts.emoticons.dropdown,editor.opts.emoticons.hidden),function(key,url){editor.EmoticonsCache[pos++]=[key,_tmpl("emoticon",{key:key,url:url.url||url,tooltip:url.tooltip||key})]}),editor.EmoticonsCache.sort(function(a,b){return a[0].length-b[0].length})),editor.longestEmoticonCode||(editor.longestEmoticonCode=editor.EmoticonsCache[editor.EmoticonsCache.length-1][0].length),editor.getRangeHelper().raplaceKeyword(editor.EmoticonsCache,!0,!0,editor.longestEmoticonCode,editor.opts.emoticonsCompat,curChar)?/^\s$/.test(curChar)&&editor.opts.emoticonsCompat?!0:(e.preventDefault(),e.stopPropagation(),!1):void 0}},tooltip:"Insert an emoticon"},youtube:{_dropDown:function(editor,caller,handleIdFunc){var matches,content=_tmpl("youtubeMenu",{label:editor._("Video URL:"),insert:editor._("Insert")},!0);content.find(".button").click(function(e){var val=content.find("#link").val().replace("http://","");""!==val&&(matches=val.match(/(?:v=|v\/|embed\/|youtu.be\/)(.{11})/),matches&&(val=matches[1]),/^[a-zA-Z0-9_\-]{11}$/.test(val)?handleIdFunc(val):alert("Invalid YouTube video")),editor.closeDropDown(!0),e.preventDefault()}),editor.createDropDown(caller,"insertlink",content)},exec:function(caller){var editor=this;$.sceditor.command.get("youtube")._dropDown(editor,caller,function(id){editor.wysiwygEditorInsertHtml(_tmpl("youtube",{id:id}))})},tooltip:"Insert a YouTube video"},date:{_date:function(editor){var now=new Date,year=now.getYear(),month=now.getMonth()+1,day=now.getDate();return 2e3>year&&(year=1900+year),10>month&&(month="0"+month),10>day&&(day="0"+day),editor.opts.dateFormat.replace(/year/i,year).replace(/month/i,month).replace(/day/i,day)},exec:function(){this.insertText($.sceditor.command.get("date")._date(this))},txtExec:function(){this.insertText($.sceditor.command.get("date")._date(this))},tooltip:"Insert current date"},time:{_time:function(){var now=new Date,hours=now.getHours(),mins=now.getMinutes(),secs=now.getSeconds();return 10>hours&&(hours="0"+hours),10>mins&&(mins="0"+mins),10>secs&&(secs="0"+secs),hours+":"+mins+":"+secs},exec:function(){this.insertText($.sceditor.command.get("time")._time())},txtExec:function(){this.insertText($.sceditor.command.get("time")._time())},tooltip:"Insert current time"},ltr:{state:function(parents,firstBlock){return firstBlock&&"ltr"===firstBlock.style.direction},exec:function(){var editor=this,elm=editor.getRangeHelper().getFirstBlockParent(),$elm=$(elm);editor.focus(),(elm&&!$elm.is("body")||(editor.execCommand("formatBlock","p"),elm=editor.getRangeHelper().getFirstBlockParent(),$elm=$(elm),elm&&!$elm.is("body")))&&("ltr"===$elm.css("direction")?$elm.css("direction",""):$elm.css("direction","ltr"))},tooltip:"Left-to-Right"},rtl:{state:function(parents,firstBlock){return firstBlock&&"rtl"===firstBlock.style.direction},exec:function(){var editor=this,elm=editor.getRangeHelper().getFirstBlockParent(),$elm=$(elm);editor.focus(),(elm&&!$elm.is("body")||(editor.execCommand("formatBlock","p"),elm=editor.getRangeHelper().getFirstBlockParent(),$elm=$(elm),elm&&!$elm.is("body")))&&("rtl"===$elm.css("direction")?$elm.css("direction",""):$elm.css("direction","rtl"))},tooltip:"Right-to-Left"},print:{exec:"print",tooltip:"Print"},maximize:{state:function(){return this.maximize()},exec:function(){this.maximize(!this.maximize())},txtExec:function(){this.maximize(!this.maximize())},tooltip:"Maximize"},source:{exec:function(){this.toggleSourceMode(),this.blur()},txtExec:function(){this.toggleSourceMode(),this.blur()},tooltip:"View source"},ignore:{}},$.sceditor.rangeHelper=function(w,d){var win,doc,init,_createMarker,_getOuterText,_selectOuterText,isW3C=!0,startMarker="sceditor-start-marker",endMarker="sceditor-end-marker",characterStr="character",base=this;init=function(window,document){doc=document||window.contentDocument||window.document,win=window,isW3C=!!window.getSelection}(w,d),base.insertHTML=function(html,endHTML){var node,div,range=base.selectedRange();if(endHTML&&(html+=base.selectedHtml()+endHTML),isW3C){for(div=doc.createElement("div"),node=doc.createDocumentFragment(),div.innerHTML=html;div.firstChild;)node.appendChild(div.firstChild);base.insertNode(node)}else{if(!range)return!1;range.pasteHTML(html)}},base.insertNode=function(node,endNode){if(isW3C){var selection,selectAfter,toInsert=doc.createDocumentFragment(),range=base.selectedRange();if(!range)return!1;toInsert.appendChild(node),endNode&&(toInsert.appendChild(range.extractContents()),toInsert.appendChild(endNode)),selectAfter=toInsert.lastChild,range.deleteContents(),range.insertNode(toInsert),selection=doc.createRange(),selection.setStartAfter(selectAfter),base.selectRange(selection)}else base.insertHTML(node.outerHTML,endNode?endNode.outerHTML:null)},base.cloneSelected=function(){var range=base.selectedRange();return range?isW3C?range.cloneRange():range.duplicate():void 0},base.selectedRange=function(){var range,parent,sel=isW3C?win.getSelection():doc.selection;if(sel&&(sel.getRangeAt&&0>=sel.rangeCount&&(range=doc.createRange(),range.setStart(doc.body,0),sel.addRange(range)),range=isW3C?sel.getRangeAt(0):sel.createRange(),!range.parentElement||!(parent=range.parentElement())||parent.ownerDocument===doc))return range},base.selectedHtml=function(){var div,range=base.selectedRange();return range?!isW3C&&""!==range.text&&range.htmlText?range.htmlText:isW3C?(div=doc.createElement("div"),div.appendChild(range.cloneContents()),div.innerHTML):"":""},base.parentNode=function(){var range=base.selectedRange();if(range){if(isW3C)return range.commonAncestorContainer;if(range.parentElement)return range.parentElement()}},base.getFirstBlockParent=function(n){var func=function(node){if(!$.sceditor.dom.isInline(node))return node;var p=node?node.parentNode:null;return p?func(p):null};return func(n||base.parentNode())},base.insertNodeAt=function(start,node){var range=base.cloneSelected();return range?(range.collapse(start),range.insertNode?range.insertNode(node):range.pasteHTML(node.outerHTML),void 0):!1},_createMarker=function(id){base.removeMarker(id);var marker=doc.createElement("span");return marker.id=id,marker.style.lineHeight="0",marker.style.display="none",marker.className="sceditor-selection",marker},base.insertMarkers=function(){base.insertNodeAt(!0,_createMarker(startMarker)),base.insertNodeAt(!1,_createMarker(endMarker))},base.getMarker=function(id){return doc.getElementById(id)},base.removeMarker=function(id){var marker=base.getMarker(id);marker&&marker.parentNode.removeChild(marker)},base.removeMarkers=function(){base.removeMarker(startMarker),base.removeMarker(endMarker)},base.saveRange=function(){base.insertMarkers()},base.selectRange=function(range){isW3C?(win.getSelection().removeAllRanges(),win.getSelection().addRange(range)):range.select()},base.restoreRange=function(){var marker,range=base.selectedRange(),start=base.getMarker(startMarker),end=base.getMarker(endMarker);return start&&end&&range?(isW3C?(range=doc.createRange(),range.setStartBefore(start),range.setEndAfter(end),base.selectRange(range)):(range=doc.body.createTextRange(),marker=doc.body.createTextRange(),marker.moveToElementText(start),range.setEndPoint("StartToStart",marker),range.moveStart(characterStr,0),marker.moveToElementText(end),range.setEndPoint("EndToStart",marker),range.moveEnd(characterStr,0),base.selectRange(range)),base.removeMarkers(),void 0):!1},_selectOuterText=function(left,right){var range=base.cloneSelected();return range?(range.collapse(!1),isW3C?(range.setStart(range.startContainer,range.startOffset-left),range.setEnd(range.endContainer,range.endOffset+right)):(range.moveStart(characterStr,0-left),range.moveEnd(characterStr,right)),base.selectRange(range),void 0):!1},_getOuterText=function(before,length){var ret="",range=base.cloneSelected();return range?(range.collapse(!1),before?isW3C?(ret=range.startContainer.textContent.substr(0,range.startOffset),ret=ret.substr(Math.max(0,ret.length-length))):(range.moveStart(characterStr,0-length),ret=range.text):isW3C?ret=range.startContainer.textContent.substr(range.startOffset,length):(range.moveEnd(characterStr,length),ret=range.text),ret):""},base.raplaceKeyword=function(rep,includeAfter,repSorted,longestKey,requireWhiteSpace,curChar){repSorted||rep.sort(function(a,b){return a.length-b.length});var before,after,str,i,start,left,pat,lookStart,maxKeyLen=longestKey||rep[rep.length-1][0].length;if(before=after=str="",requireWhiteSpace){if(!isW3C)return!1;++maxKeyLen}for(before=_getOuterText(!0,maxKeyLen),includeAfter&&(after=_getOuterText(!1,maxKeyLen)),str=before+(null!=curChar?curChar:"")+after,i=rep.length;i--;)if(pat=RegExp("(?:[\\s    ])"+$.sceditor.regexEscape(rep[i][0])+"(?=[\\s    ])"),lookStart=before.length-1-rep[i][0].length,requireWhiteSpace&&--lookStart,lookStart=Math.max(0,lookStart),!requireWhiteSpace&&(start=str.indexOf(rep[i][0],lookStart))>-1||requireWhiteSpace&&(start=str.substr(lookStart).search(pat))>-1){if(requireWhiteSpace&&(start+=lookStart+1),start>before.length||start+rep[i][0].length+(requireWhiteSpace?1:0)<before.length)continue;return left=before.length-start,_selectOuterText(left,rep[i][0].length-left-(null!=curChar&&/^\S/.test(curChar)?1:0)),base.insertHTML(rep[i][1]),!0}return!1},base.compare=function(rangeA,rangeB){return rangeB||(rangeB=base.selectedRange()),rangeA&&rangeB?isW3C?0===rangeA.compareBoundaryPoints(Range.END_TO_END,rangeB)&&0===rangeA.compareBoundaryPoints(Range.START_TO_START,rangeB):0===rangeA.compareEndPoints("EndToEnd",rangeB)&&0===rangeA.compareEndPoints("StartToStart",rangeB):!rangeA&&!rangeB}},$.sceditor.dom={traverse:function(node,func,innermostFirst,siblingsOnly,reverse){if(node)for(node=reverse?node.lastChild:node.firstChild;null!=node;){var next=reverse?node.previousSibling:node.nextSibling;if(!innermostFirst&&func(node)===!1)return!1;if(!siblingsOnly&&this.traverse(node,func,innermostFirst,siblingsOnly,reverse)===!1)return!1;if(innermostFirst&&func(node)===!1)return!1;node=next}},rTraverse:function(node,func,innermostFirst,siblingsOnly){this.traverse(node,func,innermostFirst,siblingsOnly,!0)},blockLevelList:"|body|hr|p|div|h1|h2|h3|h4|h5|h6|address|pre|form|table|tbody|thead|tfoot|th|tr|td|li|ol|ul|blockquote|center|",isInline:function(elm,includeCodeAsBlock){return elm&&1===elm.nodeType?(elm=elm.tagName.toLowerCase(),"code"===elm?!includeCodeAsBlock:0>$.sceditor.dom.blockLevelList.indexOf("|"+elm+"|")):!0},copyCSS:function(from,to){to.style.cssText=from.style.cssText+to.style.cssText},fixNesting:function(node){var base=this,getLastInlineParent=function(node){for(;base.isInline(node.parentNode,!0);)node=node.parentNode;return node};base.traverse(node,function(node){if(1===node.nodeType&&!base.isInline(node,!0)&&base.isInline(node.parentNode,!0)){var parent=getLastInlineParent(node),rParent=parent.parentNode,before=base.extractContents(parent,node),middle=node;base.copyCSS(parent,middle),rParent.insertBefore(before,parent),rParent.insertBefore(middle,parent)}})},findCommonAncestor:function(node1,node2){return $(node1).parents().has($(node2)).first()},removeWhiteSpace:function(root){var nodeValue,regex=/[^\S|\u00A0]+/g;this.traverse(root,function(node){if(nodeValue=node.nodeValue,3===node.nodeType&&0===$(node).parents("code, pre").length&&nodeValue){if(nodeValue=nodeValue.replace(/[\r\n]+/,""),!nodeValue.length)return node.parentNode.removeChild(node),void 0;/\S|\u00A0/.test(nodeValue)?regex.test(nodeValue)&&(node.nodeValue=nodeValue.replace(regex," ")):node.nodeValue=" "}})},extractContents:function(startNode,endNode){var base=this,$commonAncestor=base.findCommonAncestor(startNode,endNode),commonAncestor=$commonAncestor?$commonAncestor.get(0):null,startReached=!1,endReached=!1;return function extract(root){var df=startNode.ownerDocument.createDocumentFragment();return base.traverse(root,function(node){if(endReached||node===endNode&&startReached)return endReached=!0,!1;node===startNode&&(startReached=!0);var c,n;startReached?jQuery.contains(node,endNode)&&1===node.nodeType?(c=extract(node),n=node.cloneNode(!1),n.appendChild(c),df.appendChild(n)):df.appendChild(node):jQuery.contains(node,startNode)&&1===node.nodeType&&(c=extract(node),n=node.cloneNode(!1),n.appendChild(c),df.appendChild(n))},!1),df}(commonAncestor)}},$.sceditor.plugins={},$.sceditor.PluginManager=function(owner){var base=this,plugins=[],editorInstance=owner,formatSignalName=function(signal){return"signal"+signal.charAt(0).toUpperCase()+signal.slice(1)},callHandlers=function(args,returnAtFirst){args=[].slice.call(args);for(var i=plugins.length,signal=formatSignalName(args.shift());i--;)if(signal in plugins[i]){if(returnAtFirst)return plugins[i][signal].apply(editorInstance,args);plugins[i][signal].apply(editorInstance,args)}};base.call=function(){callHandlers(arguments,!1)},base.callOnlyFirst=function(){return callHandlers(arguments,!0)},base.iter=function(signal){return signal=formatSignalName(signal),function(){var i=plugins.length;return{callNext:function(args){for(;i--;)if(plugins[i]&&signal in plugins[i])return plugins[i].apply(editorInstance,args)},hasNext:function(){for(var j=i;j--;)if(plugins[j]&&signal in plugins[j])return!0;return!1}}}()},base.hasHandler=function(signal){var i=plugins.length;for(signal=formatSignalName(signal);i--;)if(signal in plugins[i])return!0;return!1},base.exsists=function(plugin){return plugin in $.sceditor.plugins?(plugin=$.sceditor.plugins[plugin],"function"==typeof plugin&&"object"==typeof plugin.prototype):!1},base.isRegistered=function(plugin){var i=plugins.length;if(!base.exsists(plugin))return!1;for(;i--;)if(plugins[i]instanceof $.sceditor.plugins[plugin])return!0;return!1},base.register=function(plugin){return base.exsists(plugin)?(plugin=new $.sceditor.plugins[plugin],plugins.push(plugin),"init"in plugin&&plugin.init.apply(editorInstance),!0):!1},base.deregister=function(plugin){var removedPlugin,i=plugins.length,ret=!1;if(!base.isRegistered(plugin))return!1;for(;i--;)plugins[i]instanceof $.sceditor.plugins[plugin]&&(removedPlugin=plugins.splice(i,1)[0],ret=!0,"destroy"in removedPlugin&&removedPlugin.destroy.apply(editorInstance));return ret},base.destroy=function(){for(var i=plugins.length;i--;)"destroy"in plugins[i]&&plugins[i].destroy.apply(editorInstance);plugins=null,editorInstance=null}},$.sceditor.command={get:function(name){return $.sceditor.commands[name]||null},set:function(name,cmd){return name&&cmd?(cmd=$.extend($.sceditor.commands[name]||{},cmd),cmd.remove=function(){$.sceditor.command.remove(name)},$.sceditor.commands[name]=cmd,this):!1},remove:function(name){return $.sceditor.commands[name]&&delete $.sceditor.commands[name],this}},$.sceditor.defaultOptions={toolbar:"bold,italic,underline,strike,subscript,superscript|left,center,right,justify|font,size,color,removeformat|cut,copy,paste,pastetext|bulletlist,orderedlist|table|code,quote|horizontalrule,image,email,link,unlink|emoticon,youtube,date,time|ltr,rtl|print,maximize,source",style:"jquery.sceditor.default.css",fonts:"Arial,Arial Black,Comic Sans MS,Courier New,Georgia,Impact,Sans-serif,Serif,Times New Roman,Trebuchet MS,Verdana",colors:null,locale:"en",charset:"utf-8",emoticonsCompat:!1,emoticonsRoot:"",emoticons:{dropdown:{":)":"emoticons/smile.png",":angel:":"emoticons/angel.png",":angry:":"emoticons/angry.png","8-)":"emoticons/cool.png",":'(":"emoticons/cwy.png",":ermm:":"emoticons/ermm.png",":D":"emoticons/grin.png","<3":"emoticons/heart.png",":(":"emoticons/sad.png",":O":"emoticons/shocked.png",":P":"emoticons/tongue.png",";)":"emoticons/wink.png"},more:{":alien:":"emoticons/alien.png",":blink:":"emoticons/blink.png",":blush:":"emoticons/blush.png",":cheerful:":"emoticons/cheerful.png",":devil:":"emoticons/devil.png",":dizzy:":"emoticons/dizzy.png",":getlost:":"emoticons/getlost.png",":happy:":"emoticons/happy.png",":kissing:":"emoticons/kissing.png",":ninja:":"emoticons/ninja.png",":pinch:":"emoticons/pinch.png",":pouty:":"emoticons/pouty.png",":sick:":"emoticons/sick.png",":sideways:":"emoticons/sideways.png",":silly:":"emoticons/silly.png",":sleeping:":"emoticons/sleeping.png",":unsure:":"emoticons/unsure.png",":woot:":"emoticons/w00t.png",":wassat:":"emoticons/wassat.png"},hidden:{":whistling:":"emoticons/whistling.png",":love:":"emoticons/wub.png"}},width:null,height:null,resizeEnabled:!0,resizeMinWidth:null,resizeMinHeight:null,resizeMaxHeight:null,resizeMaxWidth:null,resizeHeight:!0,resizeWidth:!0,getHtmlHandler:null,getTextHandler:null,dateFormat:"year-month-day",toolbarContainer:null,enablePasteFiltering:!1,disablePasting:!1,readOnly:!1,rtl:!1,autofocus:!1,autoExpand:!1,autoUpdate:!1,runWithoutWysiwygSupport:!1,id:null,plugins:"",zIndex:null,parserOptions:{},dropDownCss:{}},$.fn.sceditor=function(options){var $this,ret=[];return options=options||{},options.runWithoutWysiwygSupport||$.sceditor.isWysiwygSupported?(this.each(function(){$this=this.jquery?this:$(this),$this.parents(".sceditor-container").length>0||("state"===options?ret.push(!!$this.data("sceditor")):"instance"===options?ret.push($this.data("sceditor")):$this.data("sceditor")||new $.sceditor(this,options))}),ret.length?1===ret.length?ret[0]:$(ret):this):void 0}})(jQuery,window,document),function($,window,document){"use strict";$.sceditor.BBCodeParser=function(options){if(!(this instanceof $.sceditor.BBCodeParser))return new $.sceditor.BBCodeParser(options);var init,tokenizeTag,tokenizeAttrs,parseTokens,normaliseNewLines,fixNesting,isChildAllowed,removeEmpty,fixChildren,convertToHTML,convertToBBCode,hasTag,quote,lower,last,base=this,tokenType={open:"open",content:"content",newline:"newline",close:"close"};Object.freeze&&Object.freeze(tokenType);var TokenizeToken=function(type,name,val,attrs,children,closing){var base=this;base.type=type,base.name=name,base.val=val,base.attrs=attrs||{},base.children=children||[],base.closing=closing||null};TokenizeToken.prototype={clone:function(includeChildren){var base=this;return new TokenizeToken(base.type,base.name,base.val,base.attrs,includeChildren?base.children:[],base.closing?base.closing.clone():null)},splitAt:function(splitAt){var clone,base=this,splitAtLength=0,i=base.children.length;if("number"!=typeof object&&(splitAt=$.inArray(splitAt,base.children)),0>splitAt||splitAt>i)return null;for(;i--;)i>=splitAt?splitAtLength++:i=!1;return clone=base.clone(),clone.children=base.children.splice(splitAt,splitAtLength),clone}},init=function(){base.opts=$.extend({},$.sceditor.BBCodeParser.defaults,options),base.bbcodes=$.sceditorBBCodePlugin.bbcodes},base.tokenize=function(str){var matches,type,i,toks=[],tokens=[{type:"close",regex:/^\[\/[^\[\]]+\]/},{type:"open",regex:/^\[[^\[\]]+\]/},{type:"newline",regex:/^(\r\n|\r|\n)/},{type:"content",regex:/^([^\[\r\n]+|\[)/}];tokens.reverse();strloop:for(;str.length;){for(i=tokens.length;i--;)if(type=tokens[i].type,(matches=str.match(tokens[i].regex))&&matches[0]){toks.push(tokenizeTag(type,matches[0])),str=str.substr(matches[0].length);continue strloop}str.length&&toks.push(tokenizeTag(tokenType.content,str)),str=""}return toks},tokenizeTag=function(type,val){var matches,attrs,name;return"open"===type?(matches=val.match(/\[([^\]\s=]+)(?:([^\]]+))?\]/),matches?(name=lower(matches[1]),matches[2]&&(matches[2]=$.trim(matches[2]))&&(attrs=tokenizeAttrs(matches[2]))):(type="content",name="#")):"close"===type?(matches=val.match(/\[\/([^\[\]]+)\]/),matches?name=lower(matches[1]):(type="content",name="#")):name="newline"===type?"#newline":"#",new TokenizeToken(type,name,val,attrs)},tokenizeAttrs=function(attrs){var matches,unquote,atribsRegex=/([^\s=]+)=(?:(?:(["'])((?:\\\2|[^\2])*?)\2)|((?:.(?!\s\S+=))*.))/g,ret={};if(unquote=function(str,quote){return quote&&(str=str.replace("\\\\","\\").replace("\\"+quote,quote)),str},"="===attrs.charAt(0)&&2>=attrs.split("=").length)ret.defaultattr=$.sceditorBBCodePlugin.stripQuotes(attrs.substr(1));else for("="===attrs.charAt(0)&&(attrs="defaultattr"+attrs);matches=atribsRegex.exec(attrs);)ret[lower(matches[1])]=unquote(matches[3],matches[2])||matches[4];return ret},base.parse=function(str,preserveNewLines){var ret=parseTokens(base.tokenize(str));return base.opts.fixInvalidChildren&&fixChildren(ret),base.opts.removeEmptyTags&&removeEmpty(ret),base.opts.fixInvalidNesting&&fixNesting(ret),normaliseNewLines(ret,null,preserveNewLines),base.opts.removeEmptyTags&&removeEmpty(ret),ret},hasTag=function(name,type,arr){for(var i=arr.length;i--;)if(arr[i].type===type&&arr[i].name===name)return!0;return!1},isChildAllowed=function(parent,child){var bbcode=parent?base.bbcodes[parent.name]:null,allowedChildren=bbcode?bbcode.allowedChildren:null;return base.opts.fixInvalidChildren&&allowedChildren?allowedChildren&&0>$.inArray(child.name||"#",allowedChildren)?!1:!0:!0},parseTokens=function(toks){for(var token,bbcode,curTok,clone,i,previous,next,cloned=[],output=[],openTags=[],currentOpenTag=function(){return last(openTags)},addTag=function(token){currentOpenTag()?currentOpenTag().children.push(token):output.push(token)},closesCurrentTag=function(name){return currentOpenTag()&&(bbcode=base.bbcodes[currentOpenTag().name])&&bbcode.closedBy&&$.inArray(name,bbcode.closedBy)>-1};token=toks.shift();){switch(next=toks[0],token.type){case tokenType.open:closesCurrentTag(token.name)&&openTags.pop(),addTag(token),bbcode=base.bbcodes[token.name],bbcode&&bbcode.isSelfClosing||!bbcode&&!hasTag(token.name,tokenType.close,toks)||openTags.push(token);break;case tokenType.close:if(currentOpenTag()&&token.name!==currentOpenTag().name&&closesCurrentTag("/"+token.name)&&openTags.pop(),currentOpenTag()&&token.name===currentOpenTag().name)currentOpenTag().closing=token,openTags.pop();else if(hasTag(token.name,tokenType.open,openTags)){for(;curTok=openTags.pop();){if(curTok.name===token.name){curTok.closing=token;break}clone=curTok.clone(),cloned.length>1&&clone.children.push(last(cloned)),cloned.push(clone)}for(addTag(last(cloned)),i=cloned.length;i--;)openTags.push(cloned[i]);cloned.length=0}else token.type=tokenType.content,addTag(token);break;case tokenType.newline:currentOpenTag()&&next&&closesCurrentTag((next.type===tokenType.close?"/":"")+next.name)&&(next.type!==tokenType.close||next.name!==currentOpenTag().name)&&(bbcode=base.bbcodes[currentOpenTag().name],bbcode&&bbcode.breakAfter?openTags.pop():bbcode&&bbcode.isInline===!1&&base.opts.breakAfterBlock&&bbcode.breakAfter!==!1&&openTags.pop()),addTag(token);break;default:addTag(token)}previous=token}return output},normaliseNewLines=function(children,parent,onlyRemoveBreakAfter){var token,left,right,bbcode,leftBBCode,rightBBCode,removedBreakEnd,removedBreakBefore,remove,childrenLength=children.length,i=childrenLength;for(parent&&(bbcode=base.bbcodes[parent.name]);i--;)if(token=children[i])if(token.type===tokenType.newline){if(left=i>0?children[i-1]:null,right=childrenLength-1>i?children[i+1]:null,remove=!1,!onlyRemoveBreakAfter&&bbcode&&bbcode.isSelfClosing!==!0&&(0===i?(bbcode.isInline===!1&&base.opts.breakStartBlock&&bbcode.breakStart!==!1&&(remove=!0),bbcode.breakStart&&(remove=!0)):removedBreakEnd||childrenLength-1!==i||(bbcode.isInline===!1&&base.opts.breakEndBlock&&bbcode.breakEnd!==!1&&(remove=!0),bbcode.breakEnd&&(remove=!0),removedBreakEnd=remove)),left&&left.type===tokenType.open&&(leftBBCode=base.bbcodes[left.name])&&(onlyRemoveBreakAfter?leftBBCode.isInline===!1&&(remove=!0):(leftBBCode.isInline===!1&&base.opts.breakAfterBlock&&leftBBCode.breakAfter!==!1&&(remove=!0),leftBBCode.breakAfter&&(remove=!0))),!onlyRemoveBreakAfter&&!removedBreakBefore&&right&&right.type===tokenType.open&&(rightBBCode=base.bbcodes[right.name])&&(rightBBCode.isInline===!1&&base.opts.breakBeforeBlock&&rightBBCode.breakBefore!==!1&&(remove=!0),rightBBCode.breakBefore&&(remove=!0),removedBreakBefore=remove,remove)){children.splice(i,1);continue}remove&&children.splice(i,1),removedBreakBefore=!1}else token.type===tokenType.open&&normaliseNewLines(token.children,token,onlyRemoveBreakAfter)},fixNesting=function(children,parents,insideInline,rootArr){var token,i,parent,parentIndex,parentParentChildren,right,isInline=function(token){var bbcode=base.bbcodes[token.name];return!bbcode||bbcode.isInline!==!1};for(parents=parents||[],rootArr=rootArr||children,i=0;children.length>i;i++)if((token=children[i])&&token.type===tokenType.open){if(!isInline(token)&&insideInline&&(parent=last(parents),right=parent.splitAt(token),parentParentChildren=parents.length>1?parents[parents.length-2].children:rootArr,(parentIndex=$.inArray(parent,parentParentChildren))>-1))return right.children.splice($.inArray(token,right.children),1),parentParentChildren.splice(parentIndex+1,0,token,right),void 0;parents.push(token),fixNesting(token.children,parents,insideInline||isInline(token),rootArr),parents.pop(token)}},fixChildren=function(children,parent){for(var token,args,i=children.length;i--;)(token=children[i])&&(isChildAllowed(parent,token)||(token.name=null,token.type=tokenType.content,isChildAllowed(parent,token)?(args=[i+1,0].concat(token.children),token.closing&&(token.closing.name=null,token.closing.type=tokenType.content,args.push(token.closing)),i+=args.length-1,Array.prototype.splice.apply(children,args)):parent.children.splice(i,1)),token.type===tokenType.open&&fixChildren(token.children,token))},removeEmpty=function(tokens){for(var token,bbcode,i=tokens.length;i--;)(token=tokens[i])&&token.type===tokenType.open&&(bbcode=base.bbcodes[token.name],removeEmpty(token.children),1>token.children.length&&bbcode&&!bbcode.isSelfClosing&&!bbcode.allowsEmpty&&tokens.splice(i,1))},base.toHTML=function(str,preserveNewLines){return convertToHTML(base.parse(str,preserveNewLines),!0)},convertToHTML=function(tokens,isRoot){for(var token,bbcode,content,html,needsBlockWrap,blockWrapOpen,isInline,addLineBreak,ret=[];tokens.length>0;)if(token=tokens.shift()){if(token.type===tokenType.open)bbcode=base.bbcodes[token.name],isInline=!bbcode||(bbcode.isHtmlInline!==void 0?bbcode.isHtmlInline:bbcode.isInline),needsBlockWrap=isRoot&&(!bbcode||isInline!==!1),content=convertToHTML(token.children,!1),bbcode&&bbcode.html?(addLineBreak=isInline===!1&&!bbcode.isPreFormatted&&!bbcode.skipLastLineBreak,addLineBreak&&!$.sceditor.ie&&(content+="<br />"),html=$.isFunction(bbcode.html)?bbcode.html.call(base,token,token.attrs,content):$.sceditorBBCodePlugin.formatString(bbcode.html,content)):html=token.val+content+(token.closing?token.closing.val:"");
else{if(token.type===tokenType.newline){if(!isRoot){ret.push("<br />");continue}if(blockWrapOpen){ret.push("</div>\n"),blockWrapOpen=!1;continue}ret.push("<div>"),$.sceditor.ie||ret.push("<br />"),(document.documentMode&&8>document.documentMode||8>$.sceditor.ie)&&ret.push(" "),ret.push("</div>\n");continue}needsBlockWrap=isRoot,html=$.sceditor.escapeEntities(token.val)}needsBlockWrap&&!blockWrapOpen?(ret.push("<div>"),blockWrapOpen=!0):!needsBlockWrap&&blockWrapOpen&&(ret.push("</div>\n"),blockWrapOpen=!1),ret.push(html)}return blockWrapOpen&&ret.push("</div>\n"),ret.join("")},base.toBBCode=function(str,preserveNewLines){return convertToBBCode(base.parse(str,preserveNewLines))},convertToBBCode=function(toks){for(var token,attr,bbcode,isBlock,isSelfClosing,quoteType,breakBefore,breakStart,breakEnd,breakAfter,ret=[];toks.length>0;)if(token=toks.shift())if(bbcode=base.bbcodes[token.name],isBlock=!(!bbcode||bbcode.isInline!==!1),isSelfClosing=bbcode&&bbcode.isSelfClosing,breakBefore=isBlock&&base.opts.breakBeforeBlock&&bbcode.breakBefore!==!1||bbcode&&bbcode.breakBefore,breakStart=isBlock&&!isSelfClosing&&base.opts.breakStartBlock&&bbcode.breakStart!==!1||bbcode&&bbcode.breakStart,breakEnd=isBlock&&base.opts.breakEndBlock&&bbcode.breakEnd!==!1||bbcode&&bbcode.breakEnd,breakAfter=isBlock&&base.opts.breakAfterBlock&&bbcode.breakAfter!==!1||bbcode&&bbcode.breakAfter,quoteType=(bbcode?bbcode.quoteType:null)||base.opts.quoteType||$.sceditor.BBCodeParser.QuoteType.auto,bbcode||token.type!==tokenType.open)if(token.type===tokenType.open){if(breakBefore&&ret.push("\n"),ret.push("["+token.name),token.attrs){token.attrs.defaultattr&&(ret.push("="+quote(token.attrs.defaultattr,quoteType,"defaultattr")),delete token.attrs.defaultattr);for(attr in token.attrs)token.attrs.hasOwnProperty(attr)&&ret.push(" "+attr+"="+quote(token.attrs[attr],quoteType,attr))}ret.push("]"),breakStart&&ret.push("\n"),token.children&&ret.push(convertToBBCode(token.children)),isSelfClosing||bbcode.excludeClosing||(breakEnd&&ret.push("\n"),ret.push("[/"+token.name+"]")),breakAfter&&ret.push("\n"),token.closing&&isSelfClosing&&ret.push(token.closing.val)}else ret.push(token.val);else ret.push(token.val),token.children&&ret.push(convertToBBCode(token.children)),token.closing&&ret.push(token.closing.val);return ret.join("")},quote=function(str,quoteType,name){var QuoteTypes=$.sceditor.BBCodeParser.QuoteType,needsQuotes=/\s|=/.test(str);return $.isFunction(quoteType)?quoteType(str,name):quoteType===QuoteTypes.never||quoteType===QuoteTypes.auto&&!needsQuotes?str:'"'+str.replace("\\","\\\\").replace('"','\\"')+'"'},last=function(arr){return arr.length?arr[arr.length-1]:null},lower=function(str){return str.toLowerCase()},init()},$.sceditor.BBCodeParser.QuoteType={always:1,never:2,auto:3},Object.freeze&&Object.freeze($.sceditor.BBCodeParser.QuoteType),$.sceditor.BBCodeParser.defaults={breakBeforeBlock:!1,breakStartBlock:!1,breakEndBlock:!1,breakAfterBlock:!0,removeEmptyTags:!0,fixInvalidNesting:!0,fixInvalidChildren:!0,quoteType:$.sceditor.BBCodeParser.QuoteType.auto},$.sceditorBBCodePlugin=$.sceditor.plugins.bbcode=function(){var buildBbcodeCache,handleStyles,handleTags,formatString,getStyle,isEmpty,mergeSourceModeCommands,removeFirstLastDiv,base=this;formatString=$.sceditorBBCodePlugin.formatString,base.bbcodes=$.sceditorBBCodePlugin.bbcodes,base.stripQuotes=$.sceditorBBCodePlugin.stripQuotes;var tagsToBbcodes={},stylesToBbcodes={},validChildren={ul:["li","ol","ul"],ol:["li","ol","ul"],table:["tr"],tr:["td","th"],code:["br","p","div"]},propertyCache={};base.init=function(){base.opts=this.opts,buildBbcodeCache(),mergeSourceModeCommands(this)},mergeSourceModeCommands=function(editor){var merge={bold:{txtExec:["[b]","[/b]"]},italic:{txtExec:["[i]","[/i]"]},underline:{txtExec:["[u]","[/u]"]},strike:{txtExec:["[s]","[/s]"]},subscript:{txtExec:["[sub]","[/sub]"]},superscript:{txtExec:["[sup]","[/sup]"]},left:{txtExec:["[left]","[/left]"]},center:{txtExec:["[center]","[/center]"]},right:{txtExec:["[right]","[/right]"]},justify:{txtExec:["[justify]","[/justify]"]},font:{txtExec:function(caller){var editor=this;$.sceditor.command.get("font")._dropDown(editor,caller,function(fontName){editor.insertText("[font="+fontName+"]","[/font]")})}},size:{txtExec:function(caller){var editor=this;$.sceditor.command.get("size")._dropDown(editor,caller,function(fontSize){editor.insertText("[size="+fontSize+"]","[/size]")})}},color:{txtExec:function(caller){var editor=this;$.sceditor.command.get("color")._dropDown(editor,caller,function(color){editor.insertText("[color="+color+"]","[/color]")})}},bulletlist:{txtExec:["[ul][li]","[/li][/ul]"]},orderedlist:{txtExec:["[ol][li]","[/li][/ol]"]},table:{txtExec:["[table][tr][td]","[/td][/tr][/table]"]},horizontalrule:{txtExec:["[hr]"]},code:{txtExec:["[code]","[/code]"]},image:{txtExec:function(caller,selected){var url=prompt(this._("Enter the image URL:"),selected);url&&this.insertText("[img]"+url+"[/img]")}},email:{txtExec:function(caller,selected){var display=selected&&selected.indexOf("@")>-1?null:selected,email=prompt(this._("Enter the e-mail address:"),display?"":selected),text=prompt(this._("Enter the displayed text:"),display||email)||email;email&&this.insertText("[email="+email+"]"+text+"[/email]")}},link:{txtExec:function(caller,selected){var display=selected&&selected.indexOf("http://")>-1?null:selected,url=prompt(this._("Enter URL:"),display?"http://":selected),text=prompt(this._("Enter the displayed text:"),display||url)||url;url&&this.insertText("[url="+url+"]"+text+"[/url]")}},quote:{txtExec:["[quote]","[/quote]"]},youtube:{txtExec:function(caller){var editor=this;$.sceditor.command.get("youtube")._dropDown(editor,caller,function(id){editor.insertText("[youtube]"+id+"[/youtube]")})}},rtl:{txtExec:["[rtl]","[/rtl]"]},ltr:{txtExec:["[ltr]","[/ltr]"]}};editor.commands=$.extend(!0,{},merge,editor.commands)},buildBbcodeCache=function(){$.each(base.bbcodes,function(bbcode){base.bbcodes[bbcode].tags!==void 0&&$.each(base.bbcodes[bbcode].tags,function(tag,values){var isBlock=base.bbcodes[bbcode].isInline===!1;tagsToBbcodes[tag]=tagsToBbcodes[tag]||{},tagsToBbcodes[tag][isBlock]=tagsToBbcodes[tag][isBlock]||{},tagsToBbcodes[tag][isBlock][bbcode]=values}),base.bbcodes[bbcode].styles!==void 0&&$.each(base.bbcodes[bbcode].styles,function(style,values){var isBlock=base.bbcodes[bbcode].isInline===!1;stylesToBbcodes[isBlock]=stylesToBbcodes[isBlock]||{},stylesToBbcodes[isBlock][style]=stylesToBbcodes[isBlock][style]||{},stylesToBbcodes[isBlock][style][bbcode]=values})})},getStyle=function(element,property){var $elm,ret,dir,textAlign,name,style=element.style;return style?(propertyCache[property]||(propertyCache[property]=$.camelCase(property)),name=propertyCache[property],"text-align"===property?($elm=$(element),dir=style.direction,textAlign=style[name]||$elm.css(property),$elm.parent().css(property)===textAlign||"block"!==$elm.css("display")||$elm.is("hr")||$elm.is("th")||(ret=textAlign),dir&&ret&&(/right/i.test(ret)&&"rtl"===dir||/left/i.test(ret)&&"ltr"===dir)?null:ret):style[name]):null},isEmpty=function(element){var childNodes=element.childNodes,i=childNodes.length;if(element.nodeValue&&/\S|\u00A0/.test(element.nodeValue))return!1;if(0===childNodes.length||1===childNodes.length&&(/br/i.test(childNodes[0].nodeName)||isEmpty(childNodes[0])))return!0;for(;i--;)if(!isEmpty(childNodes[i]))return!1;return!0},handleStyles=function(element,content,blockLevel){var elementPropVal;return blockLevel=!!blockLevel,stylesToBbcodes[blockLevel]?($.each(stylesToBbcodes[blockLevel],function(property,bbcodes){elementPropVal=getStyle(element[0],property),elementPropVal&&getStyle(element.parent()[0],property)!==elementPropVal&&$.each(bbcodes,function(bbcode,values){(/\S|\u00A0/.test(content)||base.bbcodes[bbcode].allowsEmpty||!isEmpty(element[0]))&&(!values||$.inArray(""+elementPropVal,values)>-1)&&(content=$.isFunction(base.bbcodes[bbcode].format)?base.bbcodes[bbcode].format.call(base,element,content):formatString(base.bbcodes[bbcode].format,content))})}),content):content},handleTags=function(element,content,blockLevel){var tag=element[0].nodeName.toLowerCase();if(blockLevel=!!blockLevel,tagsToBbcodes[tag]&&tagsToBbcodes[tag][blockLevel]&&$.each(tagsToBbcodes[tag][blockLevel],function(bbcode,bbcodeAttribs){if(/\S|\u00A0/.test(content)||base.bbcodes[bbcode].allowsEmpty||!isEmpty(element[0])){if(bbcodeAttribs){var runBbcode=!1;if($.each(bbcodeAttribs,function(attrib,values){return!element.attr(attrib)||values&&0>$.inArray(element.attr(attrib),values)?void 0:(runBbcode=!0,!1)}),!runBbcode)return}content=$.isFunction(base.bbcodes[bbcode].format)?base.bbcodes[bbcode].format.call(base,element,content):formatString(base.bbcodes[bbcode].format,content)}}),blockLevel&&(!$.sceditor.dom.isInline(element[0],!0)||"br"===tag)){var parent=element[0].parentNode,previousSibling=element[0].previousSibling,parentIsInline=$.sceditor.dom.isInline(parent,!0)||"body"===parent.nodeName.toLowerCase();(parentIsInline||"li"===tag||parent.lastChild!==element[0]||"br"===tag&&$.sceditor.ie)&&(content+="\n"),"br"!==tag&&!parentIsInline&&previousSibling&&3===previousSibling.nodeType&&(content="\n"+content)}return content},base.signalToSource=function(html,domBody){var parser=new $.sceditor.BBCodeParser(base.opts.parserOptions);return $.sceditor.dom.removeWhiteSpace(domBody[0]),$.trim(parser.toBBCode(base.elementToBbcode(domBody),!0))},base.elementToBbcode=function($element){return function toBBCode(node,vChildren){var ret="";return $.sceditor.dom.traverse(node,function(node){var $node=$(node),curTag="",tag=node.nodeName.toLowerCase(),vChild=validChildren[tag],isValidChild=!0;if("object"==typeof vChildren&&(isValidChild=$.inArray(tag,vChildren)>-1,isValidChild||(vChild=vChildren)),3!==node.nodeType){if($node.hasClass("sceditor-ignore"))return;"iframe"!==tag&&(curTag=toBBCode(node,vChild)),isValidChild?("code"!==tag&&(curTag=handleStyles($node,curTag),curTag=handleTags($node,curTag),curTag=handleStyles($node,curTag,!0)),ret+=handleTags($node,curTag,!0)):ret+=curTag}else!node.wholeText||node.previousSibling&&3===node.previousSibling.nodeType?node.wholeText||(ret+=node.nodeValue):ret+=0===$node.parents("code").length?node.wholeText.replace(/ +/g," "):node.wholeText},!1,!0),ret}($element.get(0))},base.signalToWysiwyg=function(text,asFragment){var parser=new $.sceditor.BBCodeParser(base.opts.parserOptions),html=parser.toHTML(text);return asFragment?removeFirstLastDiv(html):html},removeFirstLastDiv=function(html){var node,next,$output=$("<div />").hide().appendTo(document.body),output=$output[0],removeDiv=function(node){for(;next=node.firstChild;)output.insertBefore(next,node);$.sceditor.ie>=9&&output.insertBefore(document.createElement("br"),node),output.removeChild(node)};return output.innerHTML=html.replace(/<\/div>\n/g,"</div>"),node=output.firstChild,node&&"div"===node.nodeName.toLowerCase()&&removeDiv(node),node=output.lastChild,node&&"div"===node.nodeName.toLowerCase()&&removeDiv(node),output=output.innerHTML,$output.remove(),output}},$.sceditorBBCodePlugin.stripQuotes=function(str){return str.replace(/^(["'])(.*?)\1$/,"$2")},$.sceditorBBCodePlugin.formatString=function(){var args=arguments;return args[0].replace(/\{(\d+)\}/g,function(str,p1){return args[p1-0+1]!==void 0?args[p1-0+1]:"{"+p1+"}"})},$.sceditorBBCodePlugin.normaliseColour=function(color){function toHex(n){return n=parseInt(n,10),isNaN(n)?"00":(n=Math.max(0,Math.min(n,255)).toString(16),2>n.length?"0"+n:n)}var m;return(m=color.match(/rgb\((\d{1,3}),\s*?(\d{1,3}),\s*?(\d{1,3})\)/i))?"#"+toHex(m[1])+toHex(m[2]-0)+toHex(m[3]-0):(m=color.match(/#([0-f])([0-f])([0-f])\s*?$/i))?"#"+m[1]+m[1]+m[2]+m[2]+m[3]+m[3]:color},$.sceditorBBCodePlugin.bbcodes={b:{tags:{b:null,strong:null},styles:{"font-weight":["bold","bolder","401","700","800","900"]},format:"[b]{0}[/b]",html:"<strong>{0}</strong>"},i:{tags:{i:null,em:null},styles:{"font-style":["italic","oblique"]},format:"[i]{0}[/i]",html:"<em>{0}</em>"},u:{tags:{u:null},styles:{"text-decoration":["underline"]},format:"[u]{0}[/u]",html:"<u>{0}</u>"},s:{tags:{s:null,strike:null},styles:{"text-decoration":["line-through"]},format:"[s]{0}[/s]",html:"<s>{0}</s>"},sub:{tags:{sub:null},format:"[sub]{0}[/sub]",html:"<sub>{0}</sub>"},sup:{tags:{sup:null},format:"[sup]{0}[/sup]",html:"<sup>{0}</sup>"},font:{tags:{font:{face:null}},styles:{"font-family":null},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var font;return"font"===element[0].nodeName.toLowerCase()&&(font=element.attr("face"))||(font=element.css("font-family")),"[font="+this.stripQuotes(font)+"]"+content+"[/font]"},html:function(token,attrs,content){return'<font face="'+attrs.defaultattr+'">'+content+"</font>"}},size:{tags:{font:{size:null}},styles:{"font-size":null},format:function(element,content){var fontSize=element.attr("size"),size=1;return fontSize||(fontSize=element.css("fontSize")),fontSize.indexOf("px")>-1?(fontSize=fontSize.replace("px","")-0,fontSize>12&&(size=2),fontSize>15&&(size=3),fontSize>17&&(size=4),fontSize>23&&(size=5),fontSize>31&&(size=6),fontSize>47&&(size=7)):size=fontSize,"[size="+size+"]"+content+"[/size]"},html:function(token,attrs,content){return'<font size="'+attrs.defaultattr+'">'+content+"</font>"}},color:{tags:{font:{color:null}},styles:{color:null},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function($element,content){var color,element=$element[0];return"font"===element.nodeName.toLowerCase()&&(color=$element.attr("color"))||(color=element.style.color||$element.css("color")),"[color="+$.sceditorBBCodePlugin.normaliseColour(color)+"]"+content+"[/color]"},html:function(token,attrs,content){return'<font color="'+attrs.defaultattr+'">'+content+"</font>"}},ul:{tags:{ul:null},breakStart:!0,isInline:!1,skipLastLineBreak:!0,format:"[ul]{0}[/ul]",html:"<ul>{0}</ul>"},list:{breakStart:!0,isInline:!1,skipLastLineBreak:!0,html:"<ul>{0}</ul>"},ol:{tags:{ol:null},breakStart:!0,isInline:!1,skipLastLineBreak:!0,format:"[ol]{0}[/ol]",html:"<ol>{0}</ol>"},li:{tags:{li:null},isInline:!1,closedBy:["/ul","/ol","/list","*","li"],format:"[li]{0}[/li]",html:"<li>{0}</li>"},"*":{isInline:!1,closedBy:["/ul","/ol","/list","*","li"],html:"<li>{0}</li>"},table:{tags:{table:null},isInline:!1,isHtmlInline:!0,skipLastLineBreak:!0,format:"[table]{0}[/table]",html:"<table>{0}</table>"},tr:{tags:{tr:null},isInline:!1,skipLastLineBreak:!0,format:"[tr]{0}[/tr]",html:"<tr>{0}</tr>"},th:{tags:{th:null},allowsEmpty:!0,isInline:!1,format:"[th]{0}[/th]",html:"<th>{0}</th>"},td:{tags:{td:null},allowsEmpty:!0,isInline:!1,format:"[td]{0}[/td]",html:"<td>{0}</td>"},emoticon:{allowsEmpty:!0,tags:{img:{src:null,"data-sceditor-emoticon":null}},format:function(element,content){return element.attr("data-sceditor-emoticon")+content},html:"{0}"},hr:{tags:{hr:null},allowsEmpty:!0,isSelfClosing:!0,isInline:!1,format:"[hr]{0}",html:"<hr />"},img:{allowsEmpty:!0,tags:{img:{src:null}},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var attribs="",style=function(name){return element.style?element.style[name]:null};return element.attr("data-sceditor-emoticon")!==void 0?content:((element.attr("width")||element.attr("height")||style("width")||style("height"))&&(attribs="="+$(element).width()+"x"+$(element).height()),"[img"+attribs+"]"+element.attr("src")+"[/img]")},html:function(token,attrs,content){var parts,attribs="";return attrs.width!==void 0&&(attribs+=' width="'+attrs.width+'"'),attrs.height!==void 0&&(attribs+=' height="'+attrs.height+'"'),attrs.defaultattr!==void 0&&(parts=attrs.defaultattr.split(/x/i),attribs=' width="'+parts[0]+'"'+' height="'+(2===parts.length?parts[1]:parts[0])+'"'),"<img"+attribs+' src="'+content+'" />'}},url:{allowsEmpty:!0,tags:{a:{href:null}},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var url=element.attr("href");return"mailto:"===url.substr(0,7)?'[email="'+url.substr(7)+'"]'+content+"[/email]":"[url="+decodeURI(url)+"]"+content+"[/url]"},html:function(token,attrs,content){return(attrs.defaultattr===void 0||0===attrs.defaultattr.length)&&(attrs.defaultattr=content),'<a href="'+encodeURI(attrs.defaultattr)+'">'+content+"</a>"}},email:{quoteType:$.sceditor.BBCodeParser.QuoteType.never,html:function(token,attrs,content){return attrs.defaultattr===void 0&&(attrs.defaultattr=content),'<a href="mailto:'+attrs.defaultattr+'">'+content+"</a>"}},quote:{tags:{blockquote:null},isInline:!1,quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var author="",$elm=$(element),$cite=$elm.children("cite").first();return(1===$cite.length||$elm.data("author"))&&(author=$cite.text()||$elm.data("author"),$elm.data("author",author),$cite.remove(),$elm.children("cite").replaceWith(function(){return $(this).text()}),content=this.elementToBbcode($(element)),author="="+author),"[quote"+author+"]"+content+"[/quote]"},html:function(token,attrs,content){return attrs.defaultattr!==void 0&&(content="<cite>"+attrs.defaultattr+"</cite>"+content),"<blockquote>"+content+"</blockquote>"}},code:{tags:{code:null},isInline:!1,allowedChildren:["#","#newline"],format:"[code]{0}[/code]",html:"<code>{0}</code>"},left:{styles:{"text-align":["left","-webkit-left","-moz-left","-khtml-left"]},isInline:!1,format:"[left]{0}[/left]",html:'<div align="left">{0}</div>'},center:{styles:{"text-align":["center","-webkit-center","-moz-center","-khtml-center"]},isInline:!1,format:"[center]{0}[/center]",html:'<div align="center">{0}</div>'},right:{styles:{"text-align":["right","-webkit-right","-moz-right","-khtml-right"]},isInline:!1,format:"[right]{0}[/right]",html:'<div align="right">{0}</div>'},justify:{styles:{"text-align":["justify","-webkit-justify","-moz-justify","-khtml-justify"]},isInline:!1,format:"[justify]{0}[/justify]",html:'<div align="justify">{0}</div>'},youtube:{allowsEmpty:!0,tags:{iframe:{"data-youtube-id":null}},format:function(element,content){return(element=element.attr("data-youtube-id"))?"[youtube]"+element+"[/youtube]":content},html:'<iframe width="560" height="315" src="http://www.youtube.com/embed/{0}?wmode=opaque" data-youtube-id="{0}" frameborder="0" allowfullscreen></iframe>'},rtl:{styles:{direction:["rtl"]},format:"[rtl]{0}[/rtl]",html:'<div style="direction: rtl">{0}</div>'},ltr:{styles:{direction:["ltr"]},format:"[ltr]{0}[/ltr]",html:'<div style="direction: ltr">{0}</div>'},ignore:{}},$.sceditorBBCodePlugin.bbcode={get:function(name){return $.sceditorBBCodePlugin.bbcodes[name]||null},set:function(name,bbcode){return name&&bbcode?(bbcode=$.extend($.sceditorBBCodePlugin.bbcodes[name]||{},bbcode),bbcode.remove=function(){$.sceditorBBCodePlugin.bbcode.remove(name)},$.sceditorBBCodePlugin.bbcodes[name]=bbcode,this):!1},rename:function(name,newName){return this.hasOwnProperty(name)?(this[newName]=this[name],this.remove(name),this):!1},remove:function(name){return $.sceditorBBCodePlugin.bbcodes[name]&&delete $.sceditorBBCodePlugin.bbcodes[name],this}},$.fn.sceditorBBCodePlugin=function(options){return options=options||{},$.isPlainObject(options)&&(options.plugins=(options.plugins?options.plugins:"")+"bbcode"),this.sceditor(options)}}(jQuery,window,document);