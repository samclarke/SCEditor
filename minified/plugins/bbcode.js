(function($,window,document){"use strict";$.sceditor.BBCodeParser=function(options){if(!(this instanceof $.sceditor.BBCodeParser))return new $.sceditor.BBCodeParser(options);var init,tokenizeTag,tokenizeAttrs,parseTokens,normaliseNewLines,fixNesting,isChildAllowed,removeEmpty,fixChildren,convertToHTML,convertToBBCode,hasTag,quote,lower,last,base=this,tokenType={open:"open",content:"content",newline:"newline",close:"close"};Object.freeze&&Object.freeze(tokenType);var TokenizeToken=function(type,name,val,attrs,children,closing){var base=this;base.type=type,base.name=name,base.val=val,base.attrs=attrs||{},base.children=children||[],base.closing=closing||null};TokenizeToken.prototype={clone:function(includeChildren){var base=this;return new TokenizeToken(base.type,base.name,base.val,base.attrs,includeChildren?base.children:[],base.closing?base.closing.clone():null)},splitAt:function(splitAt){var clone,base=this,splitAtLength=0,i=base.children.length;if("number"!=typeof object&&(splitAt=$.inArray(splitAt,base.children)),0>splitAt||splitAt>i)return null;for(;i--;)i>=splitAt?splitAtLength++:i=!1;return clone=base.clone(),clone.children=base.children.splice(splitAt,splitAtLength),clone}},init=function(){base.opts=$.extend({},$.sceditor.BBCodeParser.defaults,options),base.bbcodes=$.sceditorBBCodePlugin.bbcodes},base.tokenize=function(str){var matches,type,i,toks=[],tokens=[{type:"close",regex:/^\[\/[^\[\]]+\]/},{type:"open",regex:/^\[[^\[\]]+\]/},{type:"newline",regex:/^(\r\n|\r|\n)/},{type:"content",regex:/^([^\[\r\n]+|\[)/}];tokens.reverse();strloop:for(;str.length;){for(i=tokens.length;i--;)if(type=tokens[i].type,(matches=str.match(tokens[i].regex))&&matches[0]){toks.push(tokenizeTag(type,matches[0])),str=str.substr(matches[0].length);continue strloop}str.length&&toks.push(tokenizeTag(tokenType.content,str)),str=""}return toks},tokenizeTag=function(type,val){var matches,attrs,name;return"open"===type?(matches=val.match(/\[([^\]\s=]+)(?:([^\]]+))?\]/),name=lower(matches[1]),matches[2]&&(matches[2]=$.trim(matches[2]))&&(attrs=tokenizeAttrs(matches[2]))):"close"===type?(matches=val.match(/\[\/([^\[\]]+)\]/),name=lower(matches[1])):name="newline"===type?"#newline":"#",new TokenizeToken(type,name,val,attrs)},tokenizeAttrs=function(attrs){var matches,unquote,atribsRegex=/([^\s=]+)=(?:(?:(["'])((?:\\\2|[^\2])*?)\2)|((?:.(?!\s\S+=))*.))/g,ret={};if(unquote=function(str,quote){return quote&&(str=str.replace("\\\\","\\").replace("\\"+quote,quote)),str},"="===attrs.charAt(0)&&2>=attrs.split("=").length)ret.defaultattr=$.sceditorBBCodePlugin.stripQuotes(attrs.substr(1));else for("="===attrs.charAt(0)&&(attrs="defaultattr"+attrs);matches=atribsRegex.exec(attrs);)ret[lower(matches[1])]=unquote(matches[3],matches[2])||matches[4];return ret},base.parse=function(str,preserveNewLines){var ret=parseTokens(base.tokenize(str));return base.opts.fixInvalidChildren&&fixChildren(ret),base.opts.removeEmptyTags&&removeEmpty(ret),base.opts.fixInvalidNesting&&fixNesting(ret),normaliseNewLines(ret,null,preserveNewLines),base.opts.removeEmptyTags&&removeEmpty(ret),ret},hasTag=function(name,type,arr){for(var i=arr.length;i--;)if(arr[i].type===type&&arr[i].name===name)return!0;return!1},isChildAllowed=function(parent,child){var bbcode=parent?base.bbcodes[parent.name]:null,allowedChildren=bbcode?bbcode.allowedChildren:null;return base.opts.fixInvalidChildren&&allowedChildren?allowedChildren&&0>$.inArray(child.name||"#",allowedChildren)?!1:!0:!0},parseTokens=function(toks){for(var token,bbcode,curTok,clone,i,previous,next,cloned=[],output=[],openTags=[],currentOpenTag=function(){return last(openTags)},addTag=function(token){currentOpenTag()?currentOpenTag().children.push(token):output.push(token)},closesCurrentTag=function(name){return currentOpenTag()&&(bbcode=base.bbcodes[currentOpenTag().name])&&bbcode.closedBy&&$.inArray(name,bbcode.closedBy)>-1};token=toks.shift();){switch(next=toks[0],token.type){case tokenType.open:closesCurrentTag(token.name)&&openTags.pop(),addTag(token),bbcode=base.bbcodes[token.name],bbcode&&bbcode.isSelfClosing||!bbcode&&!hasTag(token.name,tokenType.close,toks)||openTags.push(token);break;case tokenType.close:if(currentOpenTag()&&token.name!==currentOpenTag().name&&closesCurrentTag("/"+token.name)&&openTags.pop(),currentOpenTag()&&token.name===currentOpenTag().name)currentOpenTag().closing=token,openTags.pop();else if(hasTag(token.name,tokenType.open,openTags)){for(;curTok=openTags.pop();){if(curTok.name===token.name){curTok.closing=token;break}clone=curTok.clone(),cloned.length>1&&clone.children.push(last(cloned)),cloned.push(clone)}for(addTag(last(cloned)),i=cloned.length;i--;)openTags.push(cloned[i]);cloned.length=0}else token.type=tokenType.content,addTag(token);break;case tokenType.newline:currentOpenTag()&&next&&closesCurrentTag(next.name)&&(next.type!==tokenType.close||next.name!==currentOpenTag().name)&&(bbcode=base.bbcodes[currentOpenTag().name],bbcode&&bbcode.breakAfter?openTags.pop():bbcode&&bbcode.isInline===!1&&base.opts.breakAfterBlock&&bbcode.breakAfter!==!1&&openTags.pop()),addTag(token);break;default:addTag(token)}previous=token}return output},normaliseNewLines=function(children,parent,onlyRemoveBreakAfter){var token,left,right,bbcode,leftBBCode,rightBBCode,removedBreakEnd,removedBreakBefore,remove,childrenLength=children.length,i=childrenLength;for(parent&&(bbcode=base.bbcodes[parent.name]);i--;)if(token=children[i])if(token.type===tokenType.newline){if(left=i>0?children[i-1]:null,right=childrenLength-1>i?children[i+1]:null,remove=!1,!onlyRemoveBreakAfter&&bbcode&&bbcode.isSelfClosing!==!0&&(0===i?(bbcode.isInline===!1&&base.opts.breakStartBlock&&bbcode.breakStart!==!1&&(remove=!0),bbcode.breakStart&&(remove=!0)):removedBreakEnd||childrenLength-1!==i||(bbcode.isInline===!1&&base.opts.breakEndBlock&&bbcode.breakEnd!==!1&&(remove=!0),bbcode.breakEnd&&(remove=!0),removedBreakEnd=remove)),left&&left.type===tokenType.open&&(leftBBCode=base.bbcodes[left.name])&&(onlyRemoveBreakAfter?leftBBCode.isInline===!1&&(remove=!0):(leftBBCode.isInline===!1&&base.opts.breakAfterBlock&&leftBBCode.breakAfter!==!1&&(remove=!0),leftBBCode.breakAfter&&(remove=!0))),!onlyRemoveBreakAfter&&!removedBreakBefore&&right&&right.type===tokenType.open&&(rightBBCode=base.bbcodes[right.name])&&(rightBBCode.isInline===!1&&base.opts.breakBeforeBlock&&rightBBCode.breakBefore!==!1&&(remove=!0),rightBBCode.breakBefore&&(remove=!0),removedBreakBefore=remove,remove)){children.splice(i,1);continue}remove&&children.splice(i,1),removedBreakBefore=!1}else token.type===tokenType.open&&normaliseNewLines(token.children,token,onlyRemoveBreakAfter)},fixNesting=function(children,parents,insideInline,rootArr){var token,i,parent,parentIndex,parentParentChildren,right,isInline=function(token){var bbcode=base.bbcodes[token.name];return!bbcode||bbcode.isInline!==!1};for(parents=parents||[],rootArr=rootArr||children,i=0;children.length>i;i++)if((token=children[i])&&token.type===tokenType.open){if(!isInline(token)&&insideInline&&(parent=last(parents),right=parent.splitAt(token),parentParentChildren=parents.length>1?parents[parents.length-2].children:rootArr,(parentIndex=$.inArray(parent,parentParentChildren))>-1))return right.children.splice($.inArray(token,right.children),1),parentParentChildren.splice(parentIndex+1,0,token,right),void 0;parents.push(token),fixNesting(token.children,parents,insideInline||isInline(token),rootArr),parents.pop(token)}},fixChildren=function(children,parent){for(var token,args,i=children.length;i--;)(token=children[i])&&(isChildAllowed(parent,token)||(token.name=null,token.type=tokenType.content,isChildAllowed(parent,token)?(args=[i+1,0].concat(token.children),token.closing&&(token.closing.name=null,token.closing.type=tokenType.content,args.push(token.closing)),i+=args.length-1,Array.prototype.splice.apply(children,args)):parent.children.splice(i,1)),token.type===tokenType.open&&fixChildren(token.children,token))},removeEmpty=function(tokens){for(var token,bbcode,i=tokens.length;i--;)(token=tokens[i])&&token.type===tokenType.open&&(bbcode=base.bbcodes[token.name],removeEmpty(token.children),1>token.children.length&&bbcode&&!bbcode.isSelfClosing&&!bbcode.allowsEmpty&&tokens.splice(i,1))},base.toHTML=function(str,preserveNewLines){return convertToHTML(base.parse(str,preserveNewLines),!0)},convertToHTML=function(tokens,isRoot){for(var token,bbcode,content,html,needsBlockWrap,blockWrapOpen,isInline,addLineBreak,ret=[];tokens.length>0;)if(token=tokens.shift()){if(token.type===tokenType.open)bbcode=base.bbcodes[token.name],isInline=!bbcode||(bbcode.isHtmlInline!==void 0?bbcode.isHtmlInline:bbcode.isInline),needsBlockWrap=isRoot&&(!bbcode||isInline!==!1),content=convertToHTML(token.children,!1),bbcode&&bbcode.html?(addLineBreak=isInline===!1&&!bbcode.isPreFormatted&&!bbcode.skipLastLineBreak,addLineBreak&&!$.sceditor.ie&&(content+="<br />"),html=$.isFunction(bbcode.html)?bbcode.html.call(base,token,token.attrs,content):$.sceditorBBCodePlugin.formatString(bbcode.html,content)):html=token.val+content+(token.closing?token.closing.val:"");else{if(token.type===tokenType.newline){if(!isRoot){ret.push("<br />");continue}if(blockWrapOpen){ret.push("</div>\n"),blockWrapOpen=!1;continue}ret.push("<div>"),$.sceditor.ie||ret.push("<br />"),(document.documentMode&&8>document.documentMode||8>$.sceditor.ie)&&ret.push("Â "),ret.push("</div>\n");continue}needsBlockWrap=isRoot,html=$.sceditor.escapeEntities(token.val)}needsBlockWrap&&!blockWrapOpen?(ret.push("<div>"),blockWrapOpen=!0):!needsBlockWrap&&blockWrapOpen&&(ret.push("</div>\n"),blockWrapOpen=!1),ret.push(html)}return blockWrapOpen&&ret.push("</div>\n"),ret.join("")},base.toBBCode=function(str,preserveNewLines){return convertToBBCode(base.parse(str,preserveNewLines))},convertToBBCode=function(toks){for(var token,attr,bbcode,isBlock,isSelfClosing,quoteType,breakBefore,breakStart,breakEnd,breakAfter,ret=[];toks.length>0;)if(token=toks.shift())if(bbcode=base.bbcodes[token.name],isBlock=!(!bbcode||bbcode.isInline!==!1),isSelfClosing=bbcode&&bbcode.isSelfClosing,breakBefore=isBlock&&base.opts.breakBeforeBlock&&bbcode.breakBefore!==!1||bbcode&&bbcode.breakBefore,breakStart=isBlock&&!isSelfClosing&&base.opts.breakStartBlock&&bbcode.breakStart!==!1||bbcode&&bbcode.breakStart,breakEnd=isBlock&&base.opts.breakEndBlock&&bbcode.breakEnd!==!1||bbcode&&bbcode.breakEnd,breakAfter=isBlock&&base.opts.breakAfterBlock&&bbcode.breakAfter!==!1||bbcode&&bbcode.breakAfter,quoteType=(bbcode?bbcode.quoteType:null)||base.opts.quoteType||$.sceditor.BBCodeParser.QuoteType.auto,bbcode||token.type!==tokenType.open)if(token.type===tokenType.open){if(breakBefore&&ret.push("\n"),ret.push("["+token.name),token.attrs){token.attrs.defaultattr&&(ret.push("="+quote(token.attrs.defaultattr,quoteType)),delete token.attrs.defaultattr);for(attr in token.attrs)token.attrs.hasOwnProperty(attr)&&ret.push(" "+attr+"="+quote(token.attrs[attr],quoteType))}ret.push("]"),breakStart&&ret.push("\n"),token.children&&ret.push(convertToBBCode(token.children)),isSelfClosing||bbcode.excludeClosing||(breakEnd&&ret.push("\n"),ret.push("[/"+token.name+"]")),breakAfter&&ret.push("\n"),token.closing&&isSelfClosing&&ret.push(token.closing.val)}else ret.push(token.val);else ret.push(token.val),token.children&&ret.push(convertToBBCode(token.children)),token.closing&&ret.push(token.closing.val);return ret.join("")},quote=function(str,quoteType){var QuoteTypes=$.sceditor.BBCodeParser.QuoteType,needsQuotes=/\s|=/.test(str);return $.isFunction(quoteType)?quoteType(str):quoteType===QuoteTypes.never||quoteType===QuoteTypes.auto&&!needsQuotes?str:'"'+str.replace("\\","\\\\").replace('"','\\"')+'"'},last=function(arr){return arr.length?arr[arr.length-1]:null},lower=function(str){return str.toLowerCase()},init()},$.sceditor.BBCodeParser.QuoteType={always:1,never:2,auto:3},Object.freeze&&Object.freeze($.sceditor.BBCodeParser.QuoteType),$.sceditor.BBCodeParser.defaults={breakBeforeBlock:!1,breakStartBlock:!1,breakEndBlock:!1,breakAfterBlock:!0,removeEmptyTags:!0,fixInvalidNesting:!0,fixInvalidChildren:!0,quoteType:$.sceditor.BBCodeParser.QuoteType.auto},$.sceditorBBCodePlugin=$.sceditor.plugins.bbcode=function(){var buildBbcodeCache,handleStyles,handleTags,formatString,getStyle,isEmpty,mergeSourceModeCommands,removeFirstLastDiv,base=this;formatString=$.sceditorBBCodePlugin.formatString,base.bbcodes=$.sceditorBBCodePlugin.bbcodes,base.stripQuotes=$.sceditorBBCodePlugin.stripQuotes;var tagsToBbcodes={},stylesToBbcodes={},validChildren={ul:["li","ol","ul"],ol:["li","ol","ul"],table:["tr"],tr:["td","th"],code:["br","p","div"]},propertyCache={};base.init=function(){base.opts=this.opts,buildBbcodeCache(),mergeSourceModeCommands(this)},mergeSourceModeCommands=function(editor){var merge={bold:{txtExec:["[b]","[/b]"]},italic:{txtExec:["[i]","[/i]"]},underline:{txtExec:["[u]","[/u]"]},strike:{txtExec:["[s]","[/s]"]},subscript:{txtExec:["[sub]","[/sub]"]},superscript:{txtExec:["[sup]","[/sup]"]},left:{txtExec:["[left]","[/left]"]},center:{txtExec:["[center]","[/center]"]},right:{txtExec:["[right]","[/right]"]},justify:{txtExec:["[justify]","[/justify]"]},font:{txtExec:function(caller){var editor=this;$.sceditor.command.get("font")._dropDown(editor,caller,function(fontName){editor.insertText("[font="+fontName+"]","[/font]")})}},size:{txtExec:function(caller){var editor=this;$.sceditor.command.get("size")._dropDown(editor,caller,function(fontSize){editor.insertText("[size="+fontSize+"]","[/size]")})}},color:{txtExec:function(caller){var editor=this;$.sceditor.command.get("color")._dropDown(editor,caller,function(color){editor.insertText("[color="+color+"]","[/color]")})}},bulletlist:{txtExec:["[ul][li]","[/li][/ul]"]},orderedlist:{txtExec:["[ol][li]","[/li][/ol]"]},table:{txtExec:["[table][tr][td]","[/td][/tr][/table]"]},horizontalrule:{txtExec:["[hr]"]},code:{txtExec:["[code]","[/code]"]},image:{txtExec:function(caller,selected){var url=prompt(this._("Enter the image URL:"),selected);url&&this.insertText("[img]"+url+"[/img]")}},email:{txtExec:function(caller,selected){var display=selected&&selected.indexOf("@")>-1?null:selected,email=prompt(this._("Enter the e-mail address:"),display?"":selected),text=prompt(this._("Enter the displayed text:"),display||email)||email;email&&this.insertText("[email="+email+"]"+text+"[/email]")}},link:{txtExec:function(caller,selected){var display=selected&&selected.indexOf("http://")>-1?null:selected,url=prompt(this._("Enter URL:"),display?"http://":selected),text=prompt(this._("Enter the displayed text:"),display||url)||url;url&&this.insertText("[url="+url+"]"+text+"[/url]")}},quote:{txtExec:["[quote]","[/quote]"]},youtube:{txtExec:function(caller){var editor=this;$.sceditor.command.get("youtube")._dropDown(editor,caller,function(id){editor.insertText("[youtube]"+id+"[/youtube]")})}},rtl:{txtExec:["[rtl]","[/rtl]"]},ltr:{txtExec:["[ltr]","[/ltr]"]}};editor.commands=$.extend(!0,{},merge,editor.commands)},buildBbcodeCache=function(){$.each(base.bbcodes,function(bbcode){base.bbcodes[bbcode].tags!==void 0&&$.each(base.bbcodes[bbcode].tags,function(tag,values){var isBlock=base.bbcodes[bbcode].isInline===!1;tagsToBbcodes[tag]=tagsToBbcodes[tag]||{},tagsToBbcodes[tag][isBlock]=tagsToBbcodes[tag][isBlock]||{},tagsToBbcodes[tag][isBlock][bbcode]=values}),base.bbcodes[bbcode].styles!==void 0&&$.each(base.bbcodes[bbcode].styles,function(style,values){var isBlock=base.bbcodes[bbcode].isInline===!1;stylesToBbcodes[isBlock]=stylesToBbcodes[isBlock]||{},stylesToBbcodes[isBlock][style]=stylesToBbcodes[isBlock][style]||{},stylesToBbcodes[isBlock][style][bbcode]=values})})},getStyle=function(element,property){var $elm,ret,dir,textAlign,name,style=element.style;return style?(propertyCache[property]||(propertyCache[property]=$.camelCase(property)),name=propertyCache[property],"text-align"===property?($elm=$(element),dir=style.direction,textAlign=style[name]||$elm.css(property),$elm.parent().css(property)===textAlign||"block"!==$elm.css("display")||$elm.is("hr")||$elm.is("th")||(ret=textAlign),dir&&ret&&(/right/i.test(ret)&&"rtl"===dir||/left/i.test(ret)&&"ltr"===dir)?null:ret):style[name]):null},isEmpty=function(element){var childNodes=element.childNodes,i=childNodes.length;if(element.nodeValue&&/\S|\u00A0/.test(element.nodeValue))return!1;if(0===childNodes.length||1===childNodes.length&&(/br/i.test(childNodes[0].nodeName)||isEmpty(childNodes[0])))return!0;for(;i--;)if(!isEmpty(childNodes[i]))return!1;return!0},handleStyles=function(element,content,blockLevel){var elementPropVal;return blockLevel=!!blockLevel,stylesToBbcodes[blockLevel]?($.each(stylesToBbcodes[blockLevel],function(property,bbcodes){elementPropVal=getStyle(element[0],property),elementPropVal&&getStyle(element.parent()[0],property)!==elementPropVal&&$.each(bbcodes,function(bbcode,values){(/\S|\u00A0/.test(content)||base.bbcodes[bbcode].allowsEmpty||!isEmpty(element[0]))&&(!values||$.inArray(""+elementPropVal,values)>-1)&&(content=$.isFunction(base.bbcodes[bbcode].format)?base.bbcodes[bbcode].format.call(base,element,content):formatString(base.bbcodes[bbcode].format,content))})}),content):content},handleTags=function(element,content,blockLevel){var tag=element[0].nodeName.toLowerCase();if(blockLevel=!!blockLevel,tagsToBbcodes[tag]&&tagsToBbcodes[tag][blockLevel]&&$.each(tagsToBbcodes[tag][blockLevel],function(bbcode,bbcodeAttribs){if(/\S|\u00A0/.test(content)||base.bbcodes[bbcode].allowsEmpty||!isEmpty(element[0])){if(bbcodeAttribs){var runBbcode=!1;if($.each(bbcodeAttribs,function(attrib,values){return!element.attr(attrib)||values&&0>$.inArray(element.attr(attrib),values)?void 0:(runBbcode=!0,!1)}),!runBbcode)return}content=$.isFunction(base.bbcodes[bbcode].format)?base.bbcodes[bbcode].format.call(base,element,content):formatString(base.bbcodes[bbcode].format,content)}}),blockLevel&&(!$.sceditor.dom.isInline(element[0],!0)||"br"===tag)){var parent=element[0].parentNode,previousSibling=element[0].previousSibling,parentIsInline=$.sceditor.dom.isInline(parent,!0)||"body"===parent.nodeName.toLowerCase();(parentIsInline||"li"===tag||parent.lastChild!==element[0]||"br"===tag&&$.sceditor.ie)&&(content+="\n"),"br"!==tag&&!parentIsInline&&previousSibling&&3===previousSibling.nodeType&&(content="\n"+content)}return content},base.signalToSource=function(html,domBody){var parser=new $.sceditor.BBCodeParser(base.opts.parserOptions);return $.sceditor.dom.removeWhiteSpace(domBody[0]),$.trim(parser.toBBCode(base.elementToBbcode(domBody),!0))},base.elementToBbcode=function($element){return function toBBCode(node,vChildren){var ret="";return $.sceditor.dom.traverse(node,function(node){var $node=$(node),curTag="",tag=node.nodeName.toLowerCase(),vChild=validChildren[tag],isValidChild=!0;if("object"==typeof vChildren&&(isValidChild=$.inArray(tag,vChildren)>-1,isValidChild||(vChild=vChildren)),3!==node.nodeType){if($node.hasClass("sceditor-ignore"))return;"iframe"!==tag&&(curTag=toBBCode(node,vChild)),isValidChild?("code"!==tag&&(curTag=handleStyles($node,curTag),curTag=handleTags($node,curTag),curTag=handleStyles($node,curTag,!0)),ret+=handleTags($node,curTag,!0)):ret+=curTag}else!node.wholeText||node.previousSibling&&3===node.previousSibling.nodeType?node.wholeText||(ret+=node.nodeValue):ret+=0===$node.parents("code").length?node.wholeText.replace(/ +/g," "):node.wholeText},!1,!0),ret}($element.get(0))},base.signalToWysiwyg=function(text,asFragment){var parser=new $.sceditor.BBCodeParser(base.opts.parserOptions),html=parser.toHTML(text);return asFragment?removeFirstLastDiv(html):html},removeFirstLastDiv=function(html){var node,next,$output=$("<div />").hide().appendTo(document.body),output=$output[0],removeDiv=function(node){for(;next=node.firstChild;)output.insertBefore(next,node);$.sceditor.ie>=9&&output.insertBefore(document.createElement("br"),node),output.removeChild(node)};return output.innerHTML=html.replace(/<\/div>\n/g,"</div>"),node=output.firstChild,node&&"div"===node.nodeName.toLowerCase()&&removeDiv(node),node=output.lastChild,node&&"div"===node.nodeName.toLowerCase()&&removeDiv(node),output=output.innerHTML,$output.remove(),output}},$.sceditorBBCodePlugin.stripQuotes=function(str){return str.replace(/^(["'])(.*?)\1$/,"$2")},$.sceditorBBCodePlugin.formatString=function(){var args=arguments;return args[0].replace(/\{(\d+)\}/g,function(str,p1){return args[p1-0+1]!==void 0?args[p1-0+1]:"{"+p1+"}"})},$.sceditorBBCodePlugin.normaliseColour=function(color){function toHex(n){return n=parseInt(n,10),isNaN(n)?"00":(n=Math.max(0,Math.min(n,255)).toString(16),2>n.length?"0"+n:n)}var m;return(m=color.match(/rgb\((\d{1,3}),\s*?(\d{1,3}),\s*?(\d{1,3})\)/i))?"#"+toHex(m[1])+toHex(m[2]-0)+toHex(m[3]-0):(m=color.match(/#([0-f])([0-f])([0-f])\s*?$/i))?"#"+m[1]+m[1]+m[2]+m[2]+m[3]+m[3]:color},$.sceditorBBCodePlugin.bbcodes={b:{tags:{b:null,strong:null},styles:{"font-weight":["bold","bolder","401","700","800","900"]},format:"[b]{0}[/b]",html:"<strong>{0}</strong>"},i:{tags:{i:null,em:null},styles:{"font-style":["italic","oblique"]},format:"[i]{0}[/i]",html:"<em>{0}</em>"},u:{tags:{u:null},styles:{"text-decoration":["underline"]},format:"[u]{0}[/u]",html:"<u>{0}</u>"},s:{tags:{s:null,strike:null},styles:{"text-decoration":["line-through"]},format:"[s]{0}[/s]",html:"<s>{0}</s>"},sub:{tags:{sub:null},format:"[sub]{0}[/sub]",html:"<sub>{0}</sub>"},sup:{tags:{sup:null},format:"[sup]{0}[/sup]",html:"<sup>{0}</sup>"},font:{tags:{font:{face:null}},styles:{"font-family":null},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var font;return"font"===element[0].nodeName.toLowerCase()&&(font=element.attr("face"))||(font=element.css("font-family")),"[font="+this.stripQuotes(font)+"]"+content+"[/font]"},html:function(token,attrs,content){return'<font face="'+attrs.defaultattr+'">'+content+"</font>"}},size:{tags:{font:{size:null}},styles:{"font-size":null},format:function(element,content){var fontSize=element.attr("size"),size=1;return fontSize||(fontSize=element.css("fontSize")),fontSize.indexOf("px")>-1?(fontSize=fontSize.replace("px","")-0,fontSize>12&&(size=2),fontSize>15&&(size=3),fontSize>17&&(size=4),fontSize>23&&(size=5),fontSize>31&&(size=6),fontSize>47&&(size=7)):size=fontSize,"[size="+size+"]"+content+"[/size]"},html:function(token,attrs,content){return'<font size="'+attrs.defaultattr+'">'+content+"</font>"}},color:{tags:{font:{color:null}},styles:{color:null},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function($element,content){var color,element=$element[0];return"font"===element.nodeName.toLowerCase()&&(color=$element.attr("color"))||(color=element.style.color||$element.css("color")),"[color="+$.sceditorBBCodePlugin.normaliseColour(color)+"]"+content+"[/color]"},html:function(token,attrs,content){return'<font color="'+attrs.defaultattr+'">'+content+"</font>"}},ul:{tags:{ul:null},breakStart:!0,isInline:!1,skipLastLineBreak:!0,format:"[ul]{0}[/ul]",html:"<ul>{0}</ul>"},list:{breakStart:!0,isInline:!1,skipLastLineBreak:!0,html:"<ul>{0}</ul>"},ol:{tags:{ol:null},breakStart:!0,isInline:!1,skipLastLineBreak:!0,format:"[ol]{0}[/ol]",html:"<ol>{0}</ol>"},li:{tags:{li:null},isInline:!1,closedBy:["/ul","/ol","/list","*","li"],format:"[li]{0}[/li]",html:"<li>{0}</li>"},"*":{isInline:!1,closedBy:["/ul","/ol","/list","*","li"],html:"<li>{0}</li>"},table:{tags:{table:null},isInline:!1,isHtmlInline:!0,skipLastLineBreak:!0,format:"[table]{0}[/table]",html:"<table>{0}</table>"},tr:{tags:{tr:null},isInline:!1,skipLastLineBreak:!0,format:"[tr]{0}[/tr]",html:"<tr>{0}</tr>"},th:{tags:{th:null},allowsEmpty:!0,isInline:!1,format:"[th]{0}[/th]",html:"<th>{0}</th>"},td:{tags:{td:null},allowsEmpty:!0,isInline:!1,format:"[td]{0}[/td]",html:"<td>{0}</td>"},emoticon:{allowsEmpty:!0,tags:{img:{src:null,"data-sceditor-emoticon":null}},format:function(element,content){return element.attr("data-sceditor-emoticon")+content},html:"{0}"},hr:{tags:{hr:null},allowsEmpty:!0,isSelfClosing:!0,isInline:!1,format:"[hr]{0}",html:"<hr />"},img:{allowsEmpty:!0,tags:{img:{src:null}},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var attribs="",style=function(name){return element.style?element.style[name]:null};return element.attr("data-sceditor-emoticon")!==void 0?content:((element.attr("width")||element.attr("height")||style("width")||style("height"))&&(attribs="="+$(element).width()+"x"+$(element).height()),"[img"+attribs+"]"+element.attr("src")+"[/img]")},html:function(token,attrs,content){var parts,attribs="";return attrs.width!==void 0&&(attribs+=' width="'+attrs.width+'"'),attrs.height!==void 0&&(attribs+=' height="'+attrs.height+'"'),attrs.defaultattr!==void 0&&(parts=attrs.defaultattr.split(/x/i),attribs=' width="'+parts[0]+'"'+' height="'+(2===parts.length?parts[1]:parts[0])+'"'),"<img"+attribs+' src="'+content+'" />'}},url:{allowsEmpty:!0,tags:{a:{href:null}},quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var url=element.attr("href");return"mailto:"===url.substr(0,7)?'[email="'+url.substr(7)+'"]'+content+"[/email]":"[url="+decodeURI(url)+"]"+content+"[/url]"},html:function(token,attrs,content){return(attrs.defaultattr===void 0||0===attrs.defaultattr.length)&&(attrs.defaultattr=content),'<a href="'+encodeURI(attrs.defaultattr)+'">'+content+"</a>"}},email:{quoteType:$.sceditor.BBCodeParser.QuoteType.never,html:function(token,attrs,content){return attrs.defaultattr===void 0&&(attrs.defaultattr=content),'<a href="mailto:'+attrs.defaultattr+'">'+content+"</a>"}},quote:{tags:{blockquote:null},isInline:!1,quoteType:$.sceditor.BBCodeParser.QuoteType.never,format:function(element,content){var author="",$elm=$(element),$cite=$elm.children("cite").first();return(1===$cite.length||$elm.data("author"))&&(author=$cite.text()||$elm.data("author"),$elm.data("author",author),$cite.remove(),$elm.children("cite").replaceWith(function(){return $(this).text()}),content=this.elementToBbcode($(element)),author="="+author),"[quote"+author+"]"+content+"[/quote]"},html:function(token,attrs,content){return attrs.defaultattr!==void 0&&(content="<cite>"+attrs.defaultattr+"</cite>"+content),"<blockquote>"+content+"</blockquote>"}},code:{tags:{code:null},isInline:!1,allowedChildren:["#","#newline"],format:"[code]{0}[/code]",html:"<code>{0}</code>"},left:{styles:{"text-align":["left","-webkit-left","-moz-left","-khtml-left"]},isInline:!1,format:"[left]{0}[/left]",html:'<div align="left">{0}</div>'},center:{styles:{"text-align":["center","-webkit-center","-moz-center","-khtml-center"]},isInline:!1,format:"[center]{0}[/center]",html:'<div align="center">{0}</div>'},right:{styles:{"text-align":["right","-webkit-right","-moz-right","-khtml-right"]},isInline:!1,format:"[right]{0}[/right]",html:'<div align="right">{0}</div>'},justify:{styles:{"text-align":["justify","-webkit-justify","-moz-justify","-khtml-justify"]},isInline:!1,format:"[justify]{0}[/justify]",html:'<div align="justify">{0}</div>'},youtube:{allowsEmpty:!0,tags:{iframe:{"data-youtube-id":null}},format:function(element,content){return(element=element.attr("data-youtube-id"))?"[youtube]"+element+"[/youtube]":content},html:'<iframe width="560" height="315" src="http://www.youtube.com/embed/{0}?wmode=opaque" data-youtube-id="{0}" frameborder="0" allowfullscreen></iframe>'},rtl:{styles:{direction:["rtl"]},format:"[rtl]{0}[/rtl]",html:'<div style="direction: rtl">{0}</div>'},ltr:{styles:{direction:["ltr"]},format:"[ltr]{0}[/ltr]",html:'<div style="direction: ltr">{0}</div>'},ignore:{}},$.sceditorBBCodePlugin.bbcode={get:function(name){return $.sceditorBBCodePlugin.bbcodes[name]||null},set:function(name,bbcode){return name&&bbcode?(bbcode=$.extend($.sceditorBBCodePlugin.bbcodes[name]||{},bbcode),bbcode.remove=function(){$.sceditorBBCodePlugin.bbcode.remove(name)},$.sceditorBBCodePlugin.bbcodes[name]=bbcode,this):!1},rename:function(name,newName){return this.hasOwnProperty(name)?(this[newName]=this[name],this.remove(name),this):!1},remove:function(name){return $.sceditorBBCodePlugin.bbcodes[name]&&delete $.sceditorBBCodePlugin.bbcodes[name],this}},$.fn.sceditorBBCodePlugin=function(options){return options=options||{},$.isPlainObject(options)&&(options.plugins=(options.plugins?options.plugins:"")+"bbcode"),this.sceditor(options)}})(jQuery,window,document);